import{B as G,z as J,p as ae,m as se,_ as K,l as X,F as oe,i as ne,j as ie,f as Z,N as $,E as f,G as S,H as T,o as d,c as L,w as g,d as i,I as c,k as Y,s,h as O,t as h,J as C,K as V,e as re,a as w,L as de,M as ce,n as R,q as j,S as ue,C as me,D as he}from"./index-0e36adfa.js";import{T as fe}from"./Table-a6af9276.js";import{_ as ve}from"./FormField-209e7db2.js";import{_ as ge}from"./FormCheckRadioPicker-2b9e2cbd.js";import{D as ke}from"./Cow-fe9d161b.js";import{M as N}from"./milking-acb8912e.js";import{T as W}from"./alert-407d7c38.js";import{C as _e}from"./cow-0951766f.js";import{u as pe,_ as we}from"./Top-23d04f6c.js";const ye={data(){return{milk:{date:new Date,time:"M"},milkDetail:{cow:null,qty:null,amount:null},milkDetails:[],loading:!1,alert:""}},emits:["update:modelValue","cancel","confirm"],computed:{calAmount(){return this.milkDetail.amount=this.milkDetail.qty*100,this.milkDetail.amount},user(){return this.$store.state.auth.user},value:{get(){return this.modelValue},set(t){this.$emit("update:modelValue",t)}}},watch:{data:{handler(t,l){t!=null&&(this.mode=="edit"&&(this.milkDetails=t.milkDetails),this.milk.date=new Date(t.date?t.date:new Date),this.milk.time=t.time?t.time:"M",this.milk._id=t._id)},deep:!0}},methods:{clear(){var t;this.mode==="edit"&&this.$emit("update:data",null),this.milk.date=new Date,this.milk.time="M",this.milkDetails=[],this.$emit("update:mode",""),(t=this.milk)==null||delete t._id},confirmCancel(t){this.value=!1,this.$emit(t)},confirm(){this.clear(),this.confirmCancel("confirm")},cancel(){this.clear(),this.confirmCancel("cancel")},removeDetail(t){let l=this.milkDetails.indexOf(t);l!==-1&&this.milkDetails.splice(l,1)},add(){this.milkDetail.cow&&this.milkDetail.qty>0&&this.milkDetail.amount?this.milkDetails.filter(l=>{var k;return l.cow.code===((k=this.milkDetail)==null?void 0:k.cow.code)}).length<=0?(this.milkDetails.push(this.milkDetail),this.alert="",this.milkDetail={}):this.alert="โคซ้ำ":this.alert="กรุณากรอกข้อมูลให้ครบ"},async submit(){this.loading=!0,this.alert="",this.milk.milkDetails=this.milkDetails;try{this.mode==="create"?await N.create(this.milk)&&(this.loading=!1,this.value=!1,this.confirm(),W.fire({icon:"success",title:"บันทึกข้อมูลสำเร็จ"})):await N.update(this.milk._id,this.milk)&&(this.loading=!1,this.value=!1,this.confirm(),W.fire({icon:"success",title:"บันทึกข้อมูลสำเร็จ"}))}catch(t){console.error("Error : ",t),this.loading=!1,this.alert=t.response.data.message}},formatDate(t){return J(t).format("DD/MM/YYYY")}},components:{BaseButton:ae,BaseButtons:se,CardBox:K,BaseDivider:X,OverlayLayer:oe,FormField:ve,FormControl:ne,NotificationBar:ie,BaseLevel:Z,DDLCow:ke,FormCheckRadioPicker:ge,BaseIcon:$},props:{modelValue:{type:[String,Number,Boolean],default:null},mode:{type:String,default:""},data:{type:Object,default:null}}},xe={key:0,class:"grid grid-cols-2 gap-3 mt-1"},be={class:"grid grid-cols-2 lg:grid-cols-4 gap-5"},De=s("header",{class:"flex items-stretch border-b border-gray-100 dark:border-gray-800"},[s("p",{class:"flex items-center py-3 grow font-bold"}," รายการรีดนม ")],-1),Ce={key:3,class:"overflow-x-auto"},Me=s("thead",null,[s("tr",null,[s("th",{class:"whitespace-nowrap text-center"}," โค "),s("th",{class:"whitespace-nowrap text-center"}," น้ำนมดิบ/กก. "),s("th",{class:"whitespace-nowrap text-center"}," จำนวนเงิน "),s("th")])],-1),Be={"data-label":"โค"},Ve={"data-label":"น้ำนมดิบ/กก.",class:"text-center"},Se={"data-label":"จำนวนเงิน",class:"text-right"},Te={class:"lg:w-6 whitespace-nowrap"},Ye={key:4,class:"text-center py-10 text-gray-500 dark:text-gray-400"},Ee=s("p",null,"ไม่มีรายการ...",-1),Fe=[Ee];function $e(t,l,k,y,a,o){const _=f("FormControl"),p=f("FormField"),E=f("FormCheckRadioPicker"),M=f("BaseDivider"),B=f("DDLCow"),x=f("BaseButton"),b=f("BaseButtons"),I=f("NotificationBar"),Q=f("CardBox"),U=f("OverlayLayer");return S((d(),L(U,null,{default:g(()=>[S(i(Q,{title:k.mode==="create"?"การรีดนม":"การรีดนม ("+((a.milk.time=="M"?"เช้า":"บ่าย")+" - "+o.formatDate(a.milk.date))+")",class:"shadow-lg w-full lg:w-1/2 z-50","header-icon":"close",modal:"",form:"","has-scroll":"",onSubmit:re(o.submit,["prevent"]),onHeaderIconClick:o.cancel},{default:g(()=>[k.mode!="edit"?(d(),c("div",xe,[i(p,{label:"วันที่รีดนม",help:"* ห้ามว่าง"},{default:g(()=>[i(_,{modelValue:a.milk.date,"onUpdate:modelValue":l[0]||(l[0]=m=>a.milk.date=m),icon:"calendar",type:"date",required:"",disabled:k.mode=="edit"},null,8,["modelValue","disabled"])]),_:1}),i(p,{label:"รอบ"},{default:g(()=>[i(E,{modelValue:a.milk.time,"onUpdate:modelValue":l[1]||(l[1]=m=>a.milk.time=m),type:"radio",options:{M:"เช้า",A:"บ่าย"},disabled:k.mode=="edit"},null,8,["modelValue","disabled"])]),_:1})])):Y("",!0),k.mode!="edit"?(d(),L(M,{key:1})):Y("",!0),s("div",be,[i(p,{label:"โค",help:"* ห้ามว่าง"},{default:g(()=>[i(B,{modelValue:a.milkDetail.cow,"onUpdate:modelValue":l[2]||(l[2]=m=>a.milkDetail.cow=m),valueType:"object"},null,8,["modelValue"])]),_:1}),i(p,{label:"น้ำนมดิบ/กก.",help:"* ห้ามว่าง"},{default:g(()=>[i(_,{modelValue:a.milkDetail.qty,"onUpdate:modelValue":l[3]||(l[3]=m=>a.milkDetail.qty=m),type:"number",icon:"scale"},null,8,["modelValue"])]),_:1}),i(p,{label:"จำนวนเงินรวม",help:"ราคาน้ำนมดิบ/กก. 100 บาท"},{default:g(()=>[i(_,{modelValue:o.calAmount,"onUpdate:modelValue":l[4]||(l[4]=m=>o.calAmount=m),type:"number",icon:"cashMultiple"},null,8,["modelValue"])]),_:1}),i(b,{type:"justify-start"},{default:g(()=>[i(x,{label:"เพิ่ม",color:"info",onClick:l[5]||(l[5]=m=>o.add())})]),_:1})]),a.alert?(d(),L(I,{key:2,color:"danger",outline:"",icon:"alertCircleOutline"},{default:g(()=>[O(h(a.alert),1)]),_:1})):Y("",!0),De,a.milkDetails.length>0?(d(),c("div",Ce,[s("table",null,[Me,s("tbody",null,[(d(!0),c(C,null,V(a.milkDetails,m=>(d(),c("tr",{key:m.cow._id},[s("td",Be,h(m.cow.code)+" : "+h(m.cow.name),1),s("td",Ve,h(m.qty),1),s("td",Se,h(m.amount),1),s("td",Te,[i(b,{type:"justify-end lg:justify-start","no-wrap":""},{default:g(()=>[i(x,{color:"danger",icon:"trashCanOutline",small:"",onClick:q=>o.removeDetail(m)},null,8,["onClick"])]),_:2},1024)])]))),128))])])])):(d(),c("div",Ye,Fe)),i(b,{type:"justify-center mt-3"},{default:g(()=>[i(x,{label:"บันทึก",color:"success",type:"submit",loading:a.loading},null,8,["loading"]),i(x,{label:"ยกเลิก",color:"danger",onClick:o.cancel},null,8,["onClick"])]),_:1})]),_:1},8,["title","onSubmit","onHeaderIconClick"]),[[T,o.value]])]),_:1},512)),[[T,o.value]])}const ee=G(ye,[["render",$e]]),Oe={ref:"calendarContainer",class:"min-h-full min-w-full text-gray-300"},Le={class:"w-full grid grid-cols-7"},Qe=["onClick"],qe=s("div",{class:"w-1/12"},[s("div",{class:"h-2 w-2 rounded-full bg-orange-600"})],-1),Ae={class:"w-11/12"},Ne={class:"text-xs tracking-tight text-clip overflow-hidden"},Ie=["onClick"],Ue={class:"w-1/12 mr-1"},je={class:"w-11/12"},Pe={class:"text-xs tracking-tight text-clip text-left overflow-hidden"},Re=["onClick"],ze={class:"h-6 w-6 flex justify-center items-center text-xs bg-orange-600 rounded-full shadow-sm"},He={class:"font-medium text-white"},We={class:"mt-2"},Ge=["onClick"],Je={class:"text-sm text-clip overflow-hidden items-center"},Ke=["onClick"],Xe={class:"opacity-40"},Ze=s("p",{class:"hidden md:block"},"รีดนม",-1),et=["onClick"],tt={class:"h-6 w-6 flex justify-center items-center text-xs bg-orange-600 rounded-full shadow-sm"},lt={class:"font-medium text-white"},at={key:0,class:"md:hidden"},st=["onClick"],ot={class:"text-sm text-clip overflow-hidden"},nt={__name:"Calendar",props:{events:{type:Object,required:!0}},setup(t){const l=pe();l.$subscribe((u,n)=>{I(),Q()});const k={1:"อา",2:"จ.",3:"อ.",4:"พ.",5:"พฤ",6:"ศ.",7:"ส."},y=w(0),a=w(0),o=w(0),_=w(0),p=w(!1),E=w(!1),M=w([]),B=w(""),x=w("create"),b=w({}),I=()=>{y.value=new Date(l.getYear,l.getMonth+1,0).getDate()},Q=()=>{o.value=new Date(l.getYear,l.getMonth,1).getDay()},U=()=>{a.value=new Date(l.getYear,l.getMonth,0).getDate()},m=()=>{let u=o.value<=5?35:42;_.value=u-y.value-o.value},q=u=>{let n=new Date;return l.getYear==n.getFullYear()&&l.getMonth==n.getMonth()&&u==n.getDate()},z=(u,n,e,r,v)=>l.getYear==n.substring(4,8)&&l.getMonth+(e?0:1)==n.substring(2,4)&&u==n.substring(0,2)&&r==v,te=(u,n,e)=>l.getYear==n.substring(4,8)&&l.getMonth+(e?0:1)==n.substring(2,4)&&u==n.substring(0,2),F=(u,n,e)=>{if(!n.length)return[];let r=[];return n.forEach(v=>{z(u,v.date,e)&&r.push(v)}),r},D=(u,n,e,r)=>{if(!n.length)return[];let v=[];return n.forEach(P=>{z(u,P.date,e,P.time,r)&&(v=P.milks)}),v},H=(u,n,e)=>{if(!n.length)return 0;let r=0;return n.forEach(v=>{te(u,v.date,e)&&(r+=v.sumQty)}),r},A=(u,n,e,r)=>{x.value=e?"edit":"create";let v=l.getYear+"-"+(l.getMonth+1)+"-"+u;b.value={_id:r,date:v,time:e,milkDetails:n},p.value=!0},le=(u,n)=>{const e=F(u,n);M.value=e,B.value=u,E.value=!0};return de(()=>{I(),Q(),U(),m()}),ce(()=>{Q(),U(),m()}),(u,n)=>(d(),c(C,null,[s("div",Oe,[s("div",Le,[i(we),(d(),c(C,null,V(k,e=>s("div",{key:e,class:"text-center text-sm md:text-base lg:text- font-medium border-b mt-3 border-gray-600"},h(e),1)),64)),(d(!0),c(C,null,V(o.value,e=>S((d(),c("div",{key:e,class:"h-16 md:h-36 w-full opacity-50 border-t border-gray-600 align-top"},[s("div",{class:R(["w-full h-full text-xs md:text-sm lg:text-base text-center transition-colors p-3",{"bg-slate-300 text-gray-900 font-medium  ":q(e),"hover:bg-gray-100 hover:text-gray-700":!q(e)}])},[O(h(a.value-(o.value-e))+" ",1),(d(!0),c(C,null,V(F(a.value-(o.value-e),t.events,!0),r=>S((d(),c("div",{key:r.title,class:"hidden md:block"},[s("div",{class:"w-full px-2 py-1 flex space-x-1 items-center whitespace-nowrap overflow-hidden hover:border hover:border-gray-200 cursor-pointer rounded-lg",onClick:v=>u.togglePopover(v,r)},[qe,s("div",Ae,[s("h5",Ne,h(r.title),1)])],8,Qe)])),[[T,F(a.value-(o.value-e),t.events,!0).length]])),128)),D(a.value-(o.value-e),t.events,!0).length>3?(d(),c("div",{key:0,class:"hidden md:flex mt-2 w-full px-2 py-1 space-x-2 items-center whitespace-nowrap overflow-hidden hover:text-gray-800 hover:font-medium cursor-pointer rounded-sm",onClick:r=>A(a.value-(o.value-e),D(a.value-(o.value-e),t.events,!0))},[s("div",Ue,[i($,{path:"plus"})]),s("div",je,[s("h6",Pe,h(" มีอีก "+(D(a.value-(o.value-e),t.events,!0).length-3)+" รายการ"),1)])],8,Ie)):Y("",!0),D(a.value-(o.value-e),t.events,!0).length>0?(d(),c("div",{key:1,class:"flex md:hidden h-2/3 w-full justify-center items-center",onClick:r=>A(a.value-(o.value-e),D(a.value-(o.value-e),t.events,!0))},[s("div",ze,[s("h3",He,h(D(a.value-(o.value-e),t.events,!0).length),1)])],8,Re)):Y("",!0)],2)])),[[T,o.value>0]])),128)),(d(!0),c(C,null,V(y.value,e=>(d(),c("div",{key:e,class:"h-16 md:h-36 w-full border-t border-gray-600 align-top"},[s("div",{class:R(["w-full h-full text-xs md:text-sm lg:text-base text-center transition-colors p-2",{"bg-gray-600 text-gray-900 font-medium  ":q(e),"hover:bg-gray-100 hover:text-gray-700":!q(e)}])},[O(h(e)+" ",1),s("div",We,[(d(!0),c(C,null,V(F(e,t.events),r=>S((d(),c("div",{key:r.date,class:"hidden md:block p-1"},[s("div",{class:"w-full flex p-1 shadow-lg border border-gray-800 shadow cursor-pointer rounded-md",onClick:v=>A(e,D(e,t.events,!1,r.time),r.time,r.id)},[s("p",Je,[i($,{path:r.time==="M"?"clockTimeSevenOutline":"clockTimeThreeOutline",class:R(r.time==="M"?"text-yellow-400":"text-orange-500")},null,8,["path","class"]),O(" "+h(r.time=="M"?"เช้า":"บ่าย")+" - "+h(r.sumQty)+" กก. ",1)])],8,Ge)])),[[T,F(e,t.events).length>0]])),128))]),S(s("div",null,[s("div",{class:"w-full mt-2 text-center items-center overflow-hidden hover:border hover:border-gray-200 cursor-pointer rounded-lg",onClick:r=>A(e,D(e,t.events))},[s("div",Xe,[i($,{path:"plus"}),O(),Ze])],8,Ke)],512),[[T,F(e,t.events).length===0]]),H(e,t.events)>0?(d(),c("div",{key:0,class:"flex md:hidden h-2/3 w-full justify-center items-center",onClick:r=>le(e,t.events)},[s("div",tt,[s("h3",lt,h(H(e,t.events)),1)])],8,et)):Y("",!0)],2)]))),128)),(d(!0),c(C,null,V(_.value,e=>S((d(),c("div",{key:e,class:"h-16 md:h-36 w-full opacity-50"})),[[T,_.value>0]])),128))]),i(Z,{type:"justify-between w-full mt-2",class:"md:hidden"},{default:g(()=>[i($,{path:"chevronLeft",size:"30",class:"cursor-pointer hover:text-gray-300",onClick:n[0]||(n[0]=e=>j(l).decrementMonth(1))}),i($,{path:"chevronRight",size:"30",class:"cursor-pointer hover:text-gray-300",onClick:n[1]||(n[1]=e=>j(l).incrementMonth(1))})]),_:1}),i(X),E.value?(d(),c("div",at,[O(" รายการรีดนม "+h(B.value)+"/"+h(j(l).getMonth+1)+"/"+h(j(l).getYear+543)+" ",1),(d(!0),c(C,null,V(M.value,e=>S((d(),c("div",{key:e.date},[s("div",{class:"w-full text-left flex overflow-hidden p-2 mt-2 border border-gray-800 shadow cursor-pointer rounded-md",onClick:r=>A(B.value,D(B.value,t.events,!1,e.time),e.time,e.id)},[s("p",ot," รอบ "+h(e.time=="M"?"เช้า":"บ่าย")+" น้ำนมดิบ "+h(e.sumQty)+" กก. รีดแล้ว "+h(e.count)+" ตัว ",1)],8,st)])),[[T,M.value.length>0]])),128))])):Y("",!0)],512),i(ee,{modelValue:p.value,"onUpdate:modelValue":n[2]||(n[2]=e=>p.value=e),mode:x.value,data:b.value,onConfirm:u.getMilks},null,8,["modelValue","mode","data","onConfirm"])],64))}},it={data(){return{modalMilk:!1,items:[],events:[],forms:[{label:"โค",class:"lg:col-start-2",value:"cow",type:"ddl",module:"cow"},{label:"วันที่รีดนม",value:"date",icon:"calendar",type:"date"}],search:{cow:null,date:null},loading:!1,mode:"create",dataEdit:null,checked:{code:{value:"date",type:"date"},label:{value:"cow.name"}},datas:[{label:"วันที่รีดนม",class:"text-center",type:"date",value:"date"},{label:"โค",class:"text-center",value:"relate.cow.name"},{label:"ปริมาณน้ำนมดิบ/เช้า (กก.)",class:"text-center",value:"morningQty"},{label:"ปริมาณน้ำนมดิบ/บ่าย (กก.)",class:"text-center",value:"afternoonQty"},{label:"ปริมาณน้ำนมดิบรวม (กก.)",class:"text-center",func:t=>t.morningQty+t.afternoonQty},{label:"จำนวนเงินรวม",class:"text-right",type:"number",value:"amount"}],buttons:[{label:"ลบ",type:"delete",color:"danger"},{label:"แก้ไข",type:"edit",color:"warning"}]}},components:{SectionMain:ue,LayoutAuthenticated:me,Table:fe,SectionTitleBarSub:he,MilkModal:ee,Calendar:nt,CardBox:K},computed:{user(){return this.$store.state.auth.user}},created(){this.getMilks()},methods:{async getMilks(){this.loading=!0;const t=await N.get(this.search);if(this.events=[],t.data)for(let l of t.data.milks){const y=(await N.getDetail({milk:l._id})).data.milkDetails;let a={};a.sumQty=0,a.sumAmt=0,y.forEach(async o=>{const _=await _e.get(o.cow);o.cow=_.data.cow,a.sumQty+=o.qty,a.sumAmt+=o.amount}),a.count=y.length,a.milks=y,a.date=J(l.date,"YYYY-MM-DD").format("DDMMYYYY"),a.time=l.time,a.id=l._id,this.events.push(a)}this.loading=!1},async removeMilk(t){this.loading=!0,(await N.delete(t)).data&&this.getMilks(),this.loading=!1},edit(t){this.dataEdit=t,this.mode="edit",this.modalMilk=!0},reset(){this.search.cow=null,this.search.date=new Date}}};function rt(t,l,k,y,a,o){const _=f("SectionTitleBarSub"),p=f("MilkModal"),E=f("Calendar"),M=f("CardBox"),B=f("SectionMain"),x=f("LayoutAuthenticated");return d(),L(x,null,{default:g(()=>[i(B,null,{default:g(()=>[i(_,{icon:"cupWater",title:"การรีดนม",btnText:"เพิ่มการรีดนม","has-btn-add":"",onOpenModal:l[0]||(l[0]=b=>{a.mode="create",a.modalMilk=!0})}),i(p,{modelValue:a.modalMilk,"onUpdate:modelValue":l[1]||(l[1]=b=>a.modalMilk=b),mode:a.mode,dataEdit:a.dataEdit,onConfirm:o.getMilks},null,8,["modelValue","mode","dataEdit","onConfirm"]),a.loading?(d(),L(M,{key:1,loading:""})):(d(),L(M,{key:0},{default:g(()=>[i(E,{events:a.events},null,8,["events"])]),_:1}))]),_:1})]),_:1})}const _t=G(it,[["render",rt]]);export{_t as default};
