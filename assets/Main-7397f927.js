import{_ as ae}from"./LayoutAuthenticated-96665147.js";import{b as z,_ as W,a as oe,d as A,c as ie}from"./BaseDivider-9edf4e01.js";import{T as H}from"./Table-2f3f3207.js";import{_ as ne}from"./SectionTitleBarSub-1350e779.js";import{v as G,x as K,h as se,_ as J,z as h,G as S,H as j,o as c,c as F,w as f,d as n,s as g,g as I,j as d,f as x,t as b,e as re,a as _,m as ce,I as me,F as D,D as O,n as P}from"./index-ae395474.js";import{a as de,_ as ue}from"./CardBoxModal-083dba37.js";import{_ as he}from"./FormField-09d99245.js";import{_ as fe}from"./FormControl-6725e5f0.js";import{_ as ke}from"./FormCheckRadioPicker-155ac12c.js";import{_ as ge}from"./NotificationBar-2b87af79.js";import{D as pe}from"./Cow-77d0c522.js";import{M as R}from"./milking-e4892683.js";import{C as ye}from"./cow-e7aeb5ac.js";import{P as be}from"./param-21bac423.js";import{T as N}from"./alert-019710c2.js";import{u as ve,_ as _e}from"./Top-059e10a4.js";import"./UserAvatar-64ee2716.js";const Me={data(){return{cowAll:!1,cowOne:!1,milk:{date:new Date,time:this.checkTime()},milkDetail:{cow:null,qty:null,amount:null},priceRawMilk:null,milkDetails:[],milkDetailColumns:[{label:"รหัสโค",value:"cow.code"},{label:"ชื่อโค",value:"cow.name"},{label:"น้ำนมดิบ (กก.)",value:"qty",class:"text-center",object:"text-box",type:"number"},{label:"จำนวนเงิน",class:"text-right",value:"amount",type:"currency"}],buttons:[{label:"ลบ",type:"delete",color:"danger"}],loading:!1,alert:{},confirmObj:{text:"",func:null,id:null,dataSelected:null,modal:!1}}},emits:["update:modelValue","cancel","confirm"],computed:{calAmount(){return this.milkDetail.amount=this.milkDetail.qty*this.priceRawMilk,this.milkDetail.amount.toFixed(2)},user(){return this.$store.state.auth.user},value:{get(){return this.modelValue},set(e){this.$emit("update:modelValue",e)}}},watch:{data:{handler(e,t){e&&(this.mode=="edit"&&(this.milkDetails=e.milkDetails),this.milk.date=e.date?new Date(e.date):new Date,this.milk._id=e._id,this.milk.time=e.time?e.time:this.checkTime(),this.getPriceRawMilk())}},"milkDetail.cow"(e){e!=null&&Object.keys(e).length>0&&this.milkDetails.length>0&&(this.alert={},this.milkDetails.filter(l=>l.cow.code===e.code).length>0&&(this.milkDetail.cow={},this.alert.text="โคซ้ำ กรุณาเลือกรายการอื่น",this.alert.color="warning"))}},created(){this.getPriceRawMilk()},methods:{async milkDetailInit(){this.milkDetails=[];const e=await ye.all();if(e.data){const t=e.data.cows;for(let l of t)(l.status==1||l.status==3)&&this.milkDetails.push({cow:{code:l.code,name:l.name}})}},clear(){this.milk={},this.milk.date=new Date,this.milk.time="M",this.milkDetails=[]},confirmCancel(e){this.value=!1,this.$emit(e)},confirm(){this.clear(),this.confirmCancel("confirm")},cancel(){this.clear(),this.confirmCancel("cancel")},removeDetail(e){console.log(e);let t=this.milkDetails.indexOf(e);t!==-1&&this.milkDetails.splice(t,1)},reset(){this.milkDetail.cow={},this.milkDetail.qty=null,this.milkDetail.amount=null},checkTime(){return new Date().getHours()<=12?"M":"A"},add(){this.milkDetail.cow&&this.milkDetail.qty>0&&this.milkDetail.amount?this.milkDetails.filter(t=>{var l;return t.cow.code===((l=this.milkDetail)==null?void 0:l.cow.code)}).length<=0?(this.milkDetails.push(this.milkDetail),this.alert={},this.milkDetail={}):(this.alert.text="โคซ้ำ",this.alert.color="warning"):(this.alert.text="กรุณากรอกข้อมูลให้ครบ",this.alert.color="warning")},async milkDeleteConfirm(){this.confirm("ยืนยันลบรายการรีดนมใช่หรือไม่ ?",null,null,this.milkDelete)},async milkDelete(){this.loading=!0,await R.delete(this.milk._id)&&(this.loading=!1,this.confirm(),N.fire({icon:"success",title:"ลบข้อมูลสำเร็จ"}))},async submit(){this.loading=!0,this.alert={},this.milk.milkDetails=this.milkDetails;const e={...this.milk};try{this.mode==="create"?await R.create(e)&&(this.loading=!1,this.confirm(),N.fire({icon:"success",title:"บันทึกข้อมูลสำเร็จ"})):await R.update(this.milk._id,this.milk)&&(this.loading=!1,this.confirm(),N.fire({icon:"success",title:"บันทึกข้อมูลสำเร็จ"}))}catch(t){console.error("Error : ",t),this.loading=!1,this.alert.text=t.response.data.message,this.alert.color="danger"}},async getPriceRawMilk(){const e=await be.all({code:"RAW_MILK"});if(e.data){const t=e.data.params;t.length>0&&(this.priceRawMilk=t[0].valueNumber)}},sum(){const e=this.milkDetails.reduce((l,M)=>l+M.qty,0),t=this.milkDetails.reduce((l,M)=>l+M.amount,0);return{qty:e,amount:t}},formatDate(e){return K(e).format("DD/MM/YYYY")},confirm(e,t,l,M){this.confirmObj.text=e,this.confirmObj.func=M,this.confirmObj.id=t,this.confirmObj.dataSelected=l,this.confirmObj.modal=!0}},components:{BaseButton:z,BaseButtons:se,CardBox:W,BaseDivider:oe,OverlayLayer:de,FormField:he,FormControl:fe,NotificationBar:ge,BaseLevel:J,DDLCow:pe,FormCheckRadioPicker:ke,BaseIcon:A,Table:H,CardBoxModal:ue},props:{modelValue:{type:[String,Number,Boolean],default:null},mode:{type:String,default:""},data:{type:Object,default:null}}},we={key:0,class:"grid lg:grid-cols-4 grid-cols-2 gap-5 p-4"},De={class:"grid grid-cols-2 lg:grid-cols-5 gap-5 p-4"},xe={class:"underline decoration-2 p-2 decoration-orange-600"},Ce={class:"underline decoration-2 p-2 decoration-orange-600"};function Be(e,t,l,M,o,s){const k=h("FormControl"),p=h("FormField"),C=h("FormCheckRadioPicker"),L=h("DDLCow"),v=h("BaseButton"),B=h("BaseButtons"),V=h("NotificationBar"),T=h("BaseLevel"),Q=h("Table"),q=h("CardBoxModal"),E=h("CardBox"),w=h("OverlayLayer");return S((c(),F(w,null,{default:f(()=>[S(n(E,{title:l.mode==="create"?"การรีดนม":"การรีดนม ("+((o.milk.time=="M"?"เช้า":"บ่าย")+" - "+s.formatDate(o.milk.date))+")",class:"shadow-lg w-full lg:p-4 lg:w-2/3 z-50","header-icon":"close",modal:"",form:"","has-table":"","has-scroll":"",onSubmit:re(s.submit,["prevent"]),onHeaderIconClick:s.cancel},{default:f(()=>{var Y;return[l.mode!="edit"?(c(),g("div",we,[n(p,{label:"วันที่รีดนม",help:"* ห้ามว่าง"},{default:f(()=>[n(k,{modelValue:o.milk.date,"onUpdate:modelValue":t[0]||(t[0]=m=>o.milk.date=m),icon:"calendar",type:"date",required:"",disabled:l.mode=="edit"},null,8,["modelValue","disabled"])]),_:1}),n(p,{label:"รอบ"},{default:f(()=>[n(C,{modelValue:o.milk.time,"onUpdate:modelValue":t[1]||(t[1]=m=>o.milk.time=m),type:"radio",name:"milk-time",options:{M:"เช้า",A:"บ่าย"},disabled:l.mode=="edit"},null,8,["modelValue","disabled"])]),_:1})])):I("",!0),d("div",De,[n(p,{label:"โค",help:"* ห้ามว่าง",class:"col-span-2"},{default:f(()=>[n(L,{modelValue:o.milkDetail.cow,"onUpdate:modelValue":t[2]||(t[2]=m=>o.milkDetail.cow=m),valueType:"object",filter:{sex:"F",status:[1,3]}},null,8,["modelValue"])]),_:1}),n(p,{label:"น้ำนมดิบ (กก.)",help:"* ห้ามว่าง"},{default:f(()=>[n(k,{modelValue:o.milkDetail.qty,"onUpdate:modelValue":t[3]||(t[3]=m=>o.milkDetail.qty=m),type:"number",icon:"scale"},null,8,["modelValue"])]),_:1}),n(p,{label:"ราคา/กก.",help:"* ห้ามว่าง"},{default:f(()=>[n(k,{modelValue:o.priceRawMilk,"onUpdate:modelValue":t[4]||(t[4]=m=>o.priceRawMilk=m),type:"number",icon:"cash"},null,8,["modelValue"])]),_:1}),n(p,{label:"คิดเป็นเงิน"},{default:f(()=>[n(k,{modelValue:s.calAmount,"onUpdate:modelValue":t[5]||(t[5]=m=>s.calAmount=m),type:"number",icon:"cashMultiple"},null,8,["modelValue"])]),_:1})]),n(B,{class:"lg:col-span-4 col-span-2 mb-1",type:"justify-center"},{default:f(()=>[n(v,{label:"ล้าง",color:"danger",onClick:t[6]||(t[6]=m=>s.reset())}),n(v,{label:"เพิ่ม",color:"info",onClick:t[7]||(t[7]=m=>s.add())})]),_:1}),(Y=o.alert)!=null&&Y.text?(c(),F(V,{key:1,color:o.alert.color,outline:"",icon:"alertCircleOutline"},{default:f(()=>[x(b(o.alert.text),1)]),_:1},8,["color"])):I("",!0),o.milkDetails.length>0?(c(),F(T,{key:2,class:"p-1 mb-2",type:"justify-end dark:bg-gray-800"},{default:f(()=>[x(" รวมน้ำนมดิบ "),d("p",xe,b(e.$filters.number(s.sum().qty)),1),x(" กก. คิดเป็นเงิน "),d("p",Ce,b(e.$filters.currency(s.sum().amount)),1),x(" บาท ")]),_:1})):I("",!0),n(Q,{title:"รายการโครีดนม ("+o.milkDetails.length+" ตัว)",icon:"cupWater",items:o.milkDetails,datas:o.milkDetailColumns,onDelete:s.removeDetail,buttons:o.buttons,perPage:"10",loading:o.loading},null,8,["title","items","datas","onDelete","buttons","loading"]),n(B,{type:"justify-center mt-3"},{default:f(()=>[n(v,{label:"ลบ",color:"danger",onClick:s.milkDeleteConfirm},null,8,["onClick"]),n(v,{label:"ยกเลิก",color:"danger",onClick:s.cancel},null,8,["onClick"]),n(v,{label:"บันทึก",color:"success",type:"submit",disabled:o.milkDetails.length==0,loading:o.loading},null,8,["disabled","loading"])]),_:1}),n(q,{modelValue:o.confirmObj.modal,"onUpdate:modelValue":t[8]||(t[8]=m=>o.confirmObj.modal=m),title:"ยืนยันอีกครั้ง","button-label":"ยืนยัน",onConfirm:o.confirmObj.func,"has-cancel":"","has-button":""},{default:f(()=>[d("p",null,b(o.confirmObj.text),1)]),_:1},8,["modelValue","onConfirm"])]}),_:1},8,["title","onSubmit","onHeaderIconClick"]),[[j,s.value]])]),_:1},512)),[[j,s.value]])}const X=G(Me,[["render",Be]]),Ve={ref:"calendarContainer",class:"min-h-full min-w-full dark:text-gray-300 text-gray-800"},Te={class:"w-full grid grid-cols-7"},Ye=["onClick"],Oe={class:"text-sm text-clip overflow-hidden items-center"},Se={class:"lg:mt-2"},je=["onClick"],Fe={class:"text-sm text-clip overflow-hidden items-center"},Le=["onClick"],qe={class:"opacity-40"},Ae=d("p",{class:"hidden md:block"}," รีดนม",-1),Re=["onClick"],Pe={class:"font-medium text-black"},Qe={__name:"Calendar",props:{events:{type:Object,required:!0}},emits:["confirm","month","year"],setup(e,{emit:t}){const l=ve();l.$subscribe((u,r)=>{B(),V()}),t("month",l.getMonth+1),t("year",l.getYear);const M={1:"อา",2:"จ.",3:"อ.",4:"พ.",5:"พฤ",6:"ศ.",7:"ส."},o=_(0),s=_(0),k=_(0),p=_(0),C=_(!1);_(!1),_([]),_("");const L=_("create"),v=_({}),B=()=>{o.value=new Date(l.getYear,l.getMonth+1,0).getDate()},V=()=>{k.value=new Date(l.getYear,l.getMonth,1).getDay()},T=()=>{s.value=new Date(l.getYear,l.getMonth,0).getDate()},Q=()=>{let u=k.value<=4?35:42;p.value=u-o.value-k.value},q=u=>{let r=new Date;return l.getYear==r.getFullYear()&&l.getMonth==r.getMonth()&&u==r.getDate()},E=(u,r,a,i,y)=>l.getYear==r.substring(4,8)&&l.getMonth+(a?0:1)==r.substring(2,4)&&u==r.substring(0,2)&&i==y,w=(u,r,a)=>{if(!r.length)return[];let i=[];return r.forEach(y=>{E(u,y.date,a)&&i.push(y)}),i},Y=(u,r,a,i)=>{if(!r.length)return[];let y=[];return r.forEach(U=>{E(u,U.date,a,U.time,i)&&(y=U.milks)}),y},m=(u,r,a,i)=>{L.value=a?"edit":"create";let y=l.getYear+"-"+(l.getMonth+1)+"-"+u;v.value={_id:i,date:y,time:a||null,milkDetails:r},C.value=!0},Z=u=>{t("confirm",u)},$=()=>{l.decrementMonth(1),t("month",l.getMonth+1),t("year",l.getYear)},ee=()=>{l.incrementMonth(1),t("month",l.getMonth+1),t("year",l.getYear)},te=u=>{t("month",u)},le=u=>{t("year",u)};return ce(()=>{B(),V(),T(),Q()}),me(()=>{V(),T(),Q()}),(u,r)=>(c(),g(D,null,[d("div",Ve,[d("div",Te,[n(_e,{onMonth:te,onYear:le}),(c(),g(D,null,O(M,a=>d("div",{key:a,class:"text-center text-sm md:text-base lg:text- font-medium border-b mt-3 border-gray-600"},b(a),1)),64)),(c(!0),g(D,null,O(k.value,a=>S((c(),g("div",{key:a,class:"h-26 md:h-36 w-full opacity-50 border-t border-gray-600 align-top"},[d("div",{class:P(["w-full h-full text-xs md:text-sm lg:text-base text-center transition-colors p-3",{"bg-slate-300 text-gray-900 font-medium  ":q(a),"hover:bg-gray-100 hover:text-gray-700":!q(a)}])},[x(b(s.value-(k.value-a))+" ",1),(c(!0),g(D,null,O(w(s.value-(k.value-a),e.events,!0),i=>S((c(),g("div",{key:i.title,class:"hidden md:block"},[d("div",{class:"w-full flex p-1 shadow-lg border border-gray-800 shadow cursor-pointer rounded-md",onClick:y=>m(a,Y(a,e.events,!1,i.time),i.time,i.id)},[d("p",Oe,[n(A,{size:"14",path:i.time==="M"?"clockTimeSevenOutline":"clockTimeThreeOutline",class:P(i.time==="M"?"text-yellow-400":"text-orange-500")},null,8,["path","class"]),x(" "+b(i.time=="M"?"เช้า":"บ่าย")+" ("+b(i.sumQty)+") ",1)])],8,Ye)])),[[j,w(s.value-(k.value-a),e.events,!0).length]])),128))],2)])),[[j,k.value>0]])),128)),(c(!0),g(D,null,O(o.value,a=>(c(),g("div",{key:a,class:"h-24 md:h-36 w-full border-t border-gray-600 align-top"},[d("div",{class:P(["w-full h-full text-xs md:text-sm lg:text-base text-center transition-colors p-1",{"dark:bg-gray-600 bg-orange-600 text-gray-900 font-medium  ":q(a),"hover:bg-gray-100 hover:text-gray-700":!q(a)}])},[x(b(a)+" ",1),d("div",Se,[(c(!0),g(D,null,O(w(a,e.events),i=>S((c(),g("div",{key:i.date,class:"hidden md:block p-1"},[d("div",{class:"w-full flex p-1 shadow-lg border border-gray-800 shadow cursor-pointer rounded-md",onClick:y=>m(a,Y(a,e.events,!1,i.time),i.time,i.id)},[d("p",Fe,[n(A,{size:"14",path:i.time==="M"?"clockTimeSevenOutline":"clockTimeThreeOutline",class:P(i.time==="M"?"text-yellow-400":"text-orange-500")},null,8,["path","class"]),x(" "+b(i.time=="M"?"เช้า":"บ่าย")+" ("+b(i.sumQty)+") ",1)])],8,je)])),[[j,w(a,e.events).length>0]])),128))]),S(d("div",null,[d("div",{class:"w-full lg:mt-2 text-center items-center overflow-hidden hover:border hover:border-gray-200 cursor-pointer rounded-lg",onClick:i=>m(a,Y(a,e.events))},[d("div",qe,[n(A,{path:"plus"}),Ae])],8,Le)],512),[[j,w(a,e.events).length<2]]),(c(!0),g(D,null,O(w(a,e.events),i=>(c(),g("div",{key:i.date,class:"flex md:hidden mt-1 w-full justify-center items-center",onClick:y=>m(a,Y(a,e.events,!1,i.time),i.time,i.id)},[d("div",{class:P(["h-6 w-full flex justify-center items-center text-xs rounded shadow-sm",[i.time==="M"?"bg-yellow-400":"bg-orange-500"]])},[d("h3",Pe,b(i.sumQty),1)],2)],8,Re))),128))],2)]))),128)),(c(!0),g(D,null,O(p.value,a=>S((c(),g("div",{key:a,class:"h-16 md:h-36 w-full opacity-50"})),[[j,p.value>0]])),128))]),n(J,{type:"justify-between w-full mt-2",class:"md:hidden"},{default:f(()=>[n(A,{path:"chevronLeft",size:"30",class:"cursor-pointer hover:text-gray-300",onClick:r[0]||(r[0]=a=>$())}),n(A,{path:"chevronRight",size:"30",class:"cursor-pointer hover:text-gray-300",onClick:r[1]||(r[1]=a=>ee())})]),_:1})],512),n(X,{modelValue:C.value,"onUpdate:modelValue":r[2]||(r[2]=a=>C.value=a),mode:L.value,data:v.value,onConfirm:Z},null,8,["modelValue","mode","data"])],64))}},Ee={data(){return{modalMilk:!1,monthMilk:new Date().getMonth()+1,yearMilk:new Date().getFullYear(),items:[],events:[],forms:[{label:"โค",class:"lg:col-start-2",value:"cow",type:"ddl",module:"cow"},{label:"วันที่รีดนม",value:"date",icon:"calendar",type:"date"}],loading:!1,mode:"create",modalData:null,checked:{code:{value:"date",type:"date"},label:{value:"cow.name"}},datas:[{label:"วันที่รีดนม",class:"text-center",type:"date",value:"date"},{label:"โค",class:"text-center",value:"relate.cow.name"},{label:"ปริมาณน้ำนมดิบ/เช้า (กก.)",class:"text-center",value:"morningQty"},{label:"ปริมาณน้ำนมดิบ/บ่าย (กก.)",class:"text-center",value:"afternoonQty"},{label:"ปริมาณน้ำนมดิบรวม (กก.)",class:"text-center",func:e=>e.morningQty+e.afternoonQty},{label:"จำนวนเงินรวม",class:"text-right",type:"number",value:"amount"}],buttons:[{label:"ลบ",type:"delete",color:"danger"},{label:"แก้ไข",type:"edit",color:"warning"}]}},components:{SectionMain:ie,LayoutAuthenticated:ae,Table:H,SectionTitleBarSub:ne,MilkModal:X,Calendar:Qe,CardBox:W,BaseButton:z},computed:{user(){return this.$store.state.auth.user}},created(){this.getMilks()},watch:{monthMilk(e){this.getMilks()},yearMilk(e){this.getMilks()}},methods:{async mockData(){await R.mock()},async getMilks(){this.loading=!0;const e=await R.all({month:this.monthMilk,year:this.yearMilk});if(this.events=[],e.data)for(let t of e.data.milks)this.filterMilk(t);this.loading=!1},async removeMilk(e){this.loading=!0,(await R.delete(e)).data&&this.getMilks(),this.loading=!1},filterMilk(e){let t={};t.sumQty=0,t.sumAmt=0,e.milkDetails.map(l=>{l.cow=typeof l.cow=="string"?l.relate.cow:l.cow,t.sumQty+=l.qty,t.sumAmt+=l.amount}),t.count=e.milkDetails.length,t.milks=e.milkDetails,t.date=K(e.date,"YYYY-MM-DD").format("DDMMYYYY"),t.time=e.time,t.id=e._id,t.sumQty=t.sumQty.toFixed(2),this.events.push(t)},addMilk(e){this.filterMilk(e)},getMonthMilk(e){this.monthMilk=e},getYearMilk(e){this.yearMilk=e},edit(e){this.modalData=e,this.mode="edit",this.modalMilk=!0}}};function Ie(e,t,l,M,o,s){const k=h("SectionTitleBarSub"),p=h("BaseButton"),C=h("MilkModal"),L=h("Calendar"),v=h("CardBox"),B=h("SectionMain"),V=h("LayoutAuthenticated");return c(),F(V,null,{default:f(()=>[n(B,null,{default:f(()=>[n(k,{icon:"cupWater",title:"การรีดนม",btnText:"เพิ่มการรีดนม","has-btn-add":"",onOpenModal:t[0]||(t[0]=T=>{o.mode="create",o.modalMilk=!0})}),s.user.username==="devTeam"?(c(),F(p,{key:0,icon:"plus",onClick:s.mockData,label:"Mock"},null,8,["onClick"])):I("",!0),n(C,{modelValue:o.modalMilk,"onUpdate:modelValue":t[1]||(t[1]=T=>o.modalMilk=T),mode:o.mode,onConfirm:s.getMilks},null,8,["modelValue","mode","onConfirm"]),o.loading?(c(),F(v,{key:2,loading:""})):(c(),F(v,{key:1},{default:f(()=>[n(L,{events:o.events,onConfirm:s.getMilks,onMonth:s.getMonthMilk,onYear:s.getYearMilk},null,8,["events","onConfirm","onMonth","onYear"])]),_:1}))]),_:1})]),_:1})}const nt=G(Ee,[["render",Ie]]);export{nt as default};
