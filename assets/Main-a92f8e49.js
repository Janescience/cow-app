import{z as U,B as z,p as te,m as le,_ as H,l as ae,G as se,i as ie,j as oe,f as W,O as L,F as g,H as V,I as Y,o as r,c as S,w as k,d as n,J as h,k as q,s,h as N,t as p,K as x,L as b,e as ne,a as M,M as re,N as ce,n as P,C as de,D as me,T as ue,E as he}from"./index-629ff7e8.js";import{_ as fe}from"./FormField-549ee950.js";import{_ as ge}from"./FormCheckRadioPicker-842da6bf.js";import{D as ke}from"./Cow-92d853b0.js";import{M as Q}from"./milking-a3c9bb63.js";import{P as ve}from"./param-8a5de4af.js";import{T as j}from"./alert-92a2c52a.js";import{u as pe,_ as _e}from"./Top-fb39fb61.js";import"./cow-9e22cfb1.js";const we={data(){return{milk:{date:new Date,time:this.checkTime()},milkDetail:{cow:{},qty:null,amount:null},priceRawMilk:null,milkDetails:[],loading:!1,alert:{}}},emits:["update:modelValue","cancel","confirm"],computed:{calAmount(){return this.milkDetail.amount=this.milkDetail.qty*this.priceRawMilk,this.milkDetail.amount.toFixed(2)},user(){return this.$store.state.auth.user},value:{get(){return this.modelValue},set(e){this.$emit("update:modelValue",e)}}},watch:{data:{handler(e,t){e&&(this.mode=="edit"&&(this.milkDetails=e.milkDetails),this.milk.date=e.date?new Date(e.date):new Date,this.milk._id=e._id,this.milk.time=e.time?e.time:this.checkTime(),this.getPriceRawMilk())}},"milkDetail.cow"(e){e!=null&&Object.keys(e).length>0&&this.milkDetails.length>0&&(this.alert={},this.milkDetails.filter(a=>a.cow.code===e.code).length>0&&(this.milkDetail.cow={},this.alert.text="โคซ้ำ กรุณาเลือกรายการอื่น",this.alert.color="warning"))}},created(){this.getPriceRawMilk()},methods:{clear(){this.milk={},this.milk.date=new Date,this.milk.time="M",this.milkDetails=[]},confirmCancel(e){this.value=!1,this.$emit(e)},confirm(){this.clear(),this.confirmCancel("confirm")},cancel(){this.clear(),this.confirmCancel("cancel")},removeDetail(e){let t=this.milkDetails.indexOf(e);t!==-1&&this.milkDetails.splice(t,1)},reset(){this.milkDetail.cow={},this.milkDetail.qty=null,this.milkDetail.amount=null},checkTime(){return new Date().getHours()<=12?"M":"A"},add(){this.milkDetail.cow&&this.milkDetail.qty>0&&this.milkDetail.amount?this.milkDetails.filter(t=>{var a;return t.cow.code===((a=this.milkDetail)==null?void 0:a.cow.code)}).length<=0?(this.milkDetails.push(this.milkDetail),this.alert={},this.milkDetail={}):(this.alert.text="โคซ้ำ",this.alert.color="warning"):(this.alert.text="กรุณากรอกข้อมูลให้ครบ",this.alert.color="warning")},async submit(){this.loading=!0,this.alert={},this.milk.milkDetails=this.milkDetails;const e={...this.milk};try{this.mode==="create"?await Q.create(e)&&(this.loading=!1,this.confirm(),j.fire({icon:"success",title:"บันทึกข้อมูลสำเร็จ"})):await Q.update(this.milk._id,this.milk)&&(this.loading=!1,this.confirm(),j.fire({icon:"success",title:"บันทึกข้อมูลสำเร็จ"}))}catch(t){console.error("Error : ",t),this.loading=!1,this.alert.text=t.response.data.message,this.alert.color="danger"}},async getPriceRawMilk(){const e=await ve.all({code:"RAW_MILK"});if(e.data){const t=e.data.params;t.length>0&&(this.priceRawMilk=t[0].valueNumber)}},formatDate(e){return z(e).format("DD/MM/YYYY")}},components:{BaseButton:te,BaseButtons:le,CardBox:H,BaseDivider:ae,OverlayLayer:se,FormField:fe,FormControl:ie,NotificationBar:oe,BaseLevel:W,DDLCow:ke,FormCheckRadioPicker:ge,BaseIcon:L},props:{modelValue:{type:[String,Number,Boolean],default:null},mode:{type:String,default:""},data:{type:Object,default:null}}},ye={key:0,class:"grid lg:grid-cols-4 grid-cols-2 gap-5"},Me={class:"grid grid-cols-2 lg:grid-cols-4 gap-5"},xe=s("header",{class:"flex items-stretch border-b border-gray-100 dark:border-gray-800"},[s("p",{class:"flex items-center py-3 grow font-bold"}," รายการรีดนม ")],-1),be={key:3,class:"overflow-x-auto"},De=s("thead",null,[s("tr",null,[s("th",{class:"whitespace-nowrap text-center"}," รหัสโค "),s("th",{class:"whitespace-nowrap text-center"}," ชื่อโค "),s("th",{class:"whitespace-nowrap text-center"}," น้ำนมดิบ (กก.) "),s("th",{class:"whitespace-nowrap text-center"}," จำนวนเงิน "),s("th")])],-1),Ce={"data-label":"รหัสโค",class:"whitespace-nowrap"},Be={"data-label":"ชื่อโค",class:"whitespace-nowrap"},Ve={"data-label":"น้ำนมดิบ/กก.",class:"text-center whitespace-nowrap"},Ye={"data-label":"จำนวนเงิน",class:"text-right whitespace-nowrap"},Te={class:"lg:w-6 whitespace-nowrap"},Fe={key:4,class:"text-center py-10 text-gray-500 dark:text-gray-400"},Se=s("p",null,"ไม่มีรายการ...",-1),Oe=[Se];function Le(e,t,a,I,i,c){const f=g("FormControl"),_=g("FormField"),D=g("FormCheckRadioPicker"),C=g("BaseDivider"),T=g("DDLCow"),w=g("BaseButton"),y=g("BaseButtons"),A=g("NotificationBar"),R=g("CardBox"),F=g("OverlayLayer");return V((r(),S(F,null,{default:k(()=>[V(n(R,{title:a.mode==="create"?"การรีดนม":"การรีดนม ("+((i.milk.time=="M"?"เช้า":"บ่าย")+" - "+c.formatDate(i.milk.date))+")",class:"shadow-lg w-full lg:w-1/2 z-50","header-icon":"close",modal:"",form:"","has-scroll":"",onSubmit:ne(c.submit,["prevent"]),onHeaderIconClick:c.cancel},{default:k(()=>{var O;return[a.mode!="edit"?(r(),h("div",ye,[n(_,{label:"วันที่รีดนม",help:"* ห้ามว่าง"},{default:k(()=>[n(f,{modelValue:i.milk.date,"onUpdate:modelValue":t[0]||(t[0]=d=>i.milk.date=d),icon:"calendar",type:"date",required:"",disabled:a.mode=="edit"},null,8,["modelValue","disabled"])]),_:1}),n(_,{label:"รอบ"},{default:k(()=>[n(D,{modelValue:i.milk.time,"onUpdate:modelValue":t[1]||(t[1]=d=>i.milk.time=d),type:"radio",name:"milk-time",options:{M:"เช้า",A:"บ่าย"},disabled:a.mode=="edit"},null,8,["modelValue","disabled"])]),_:1})])):q("",!0),a.mode!="edit"?(r(),S(C,{key:1})):q("",!0),s("div",Me,[n(_,{label:"โค",help:"* ห้ามว่าง"},{default:k(()=>[n(T,{modelValue:i.milkDetail.cow,"onUpdate:modelValue":t[2]||(t[2]=d=>i.milkDetail.cow=d),valueType:"object"},null,8,["modelValue"])]),_:1}),n(_,{label:"น้ำนมดิบ (กก.)",help:"* ห้ามว่าง"},{default:k(()=>[n(f,{modelValue:i.milkDetail.qty,"onUpdate:modelValue":t[3]||(t[3]=d=>i.milkDetail.qty=d),type:"number",icon:"scale"},null,8,["modelValue"])]),_:1}),n(_,{label:"คิดเป็นเงิน",help:"ราคาน้ำนมดิบ/กก. "+i.priceRawMilk+" บาท"},{default:k(()=>[n(f,{modelValue:c.calAmount,"onUpdate:modelValue":t[4]||(t[4]=d=>c.calAmount=d),type:"number",icon:"cashMultiple"},null,8,["modelValue"])]),_:1},8,["help"]),n(y,{type:"justify-start"},{default:k(()=>[n(w,{label:"ล้าง",color:"danger",onClick:t[5]||(t[5]=d=>c.reset())}),n(w,{label:"เพิ่ม",color:"info",onClick:t[6]||(t[6]=d=>c.add())})]),_:1})]),(O=i.alert)!=null&&O.text?(r(),S(A,{key:2,color:i.alert.color,outline:"",icon:"alertCircleOutline"},{default:k(()=>[N(p(i.alert.text),1)]),_:1},8,["color"])):q("",!0),xe,i.milkDetails.length>0?(r(),h("div",be,[s("table",null,[De,s("tbody",null,[(r(!0),h(x,null,b(i.milkDetails,d=>(r(),h("tr",{key:d.cow._id},[s("td",Ce,p(d.cow.code),1),s("td",Be,p(d.cow.name),1),s("td",Ve,p(d.qty.toFixed(2)),1),s("td",Ye,p(d.amount.toFixed(2)),1),s("td",Te,[n(y,{type:"justify-end lg:justify-start","no-wrap":""},{default:k(()=>[n(w,{color:"danger",icon:"trashCanOutline",small:"",onClick:B=>c.removeDetail(d)},null,8,["onClick"])]),_:2},1024)])]))),128))])])])):(r(),h("div",Fe,Oe)),n(y,{type:"justify-center mt-3"},{default:k(()=>[n(w,{label:"ยกเลิก",color:"danger",onClick:c.cancel},null,8,["onClick"]),n(w,{label:"บันทึก",color:"success",type:"submit",disabled:i.milkDetails.length==0,loading:i.loading},null,8,["disabled","loading"])]),_:1})]}),_:1},8,["title","onSubmit","onHeaderIconClick"]),[[Y,c.value]])]),_:1},512)),[[Y,c.value]])}const G=U(we,[["render",Le]]),Ae={ref:"calendarContainer",class:"min-h-full min-w-full text-gray-300"},Re={class:"w-full grid grid-cols-7"},Ee=["onClick"],Pe=s("div",{class:"w-1/12"},[s("div",{class:"h-2 w-2 rounded-full bg-orange-600"})],-1),qe={class:"w-11/12"},Ne={class:"text-xs tracking-tight text-clip overflow-hidden"},Qe=["onClick"],Ie={class:"h-6 w-6 flex justify-center items-center text-xs bg-orange-600 rounded-full shadow-sm"},$e={class:"font-medium text-white"},je={class:"lg:mt-2"},Ue=["onClick"],ze={class:"text-sm text-clip overflow-hidden items-center"},He=["onClick"],We={class:"opacity-40"},Ge=s("p",{class:"hidden md:block"}," รีดนม",-1),Ke=["onClick"],Je={class:"font-medium text-black"},Xe={__name:"Calendar",props:{events:{type:Object,required:!0}},emits:["confirm","month","year"],setup(e,{emit:t}){const a=pe();a.$subscribe((u,m)=>{w(),y()}),t("month",a.getMonth+1),t("year",a.getYear);const I={1:"อา",2:"จ.",3:"อ.",4:"พ.",5:"พฤ",6:"ศ.",7:"ส."},i=M(0),c=M(0),f=M(0),_=M(0),D=M(!1);M(!1),M([]),M("");const C=M("create"),T=M({}),w=()=>{i.value=new Date(a.getYear,a.getMonth+1,0).getDate()},y=()=>{f.value=new Date(a.getYear,a.getMonth,1).getDay()},A=()=>{c.value=new Date(a.getYear,a.getMonth,0).getDate()},R=()=>{let u=f.value<=4?35:42;_.value=u-i.value-f.value},F=u=>{let m=new Date;return a.getYear==m.getFullYear()&&a.getMonth==m.getMonth()&&u==m.getDate()},O=(u,m,l,o,v)=>a.getYear==m.substring(4,8)&&a.getMonth+(l?0:1)==m.substring(2,4)&&u==m.substring(0,2)&&o==v,d=(u,m,l)=>{if(!m.length)return[];let o=[];return m.forEach(v=>{O(u,v.date,l)&&o.push(v)}),o},B=(u,m,l,o)=>{if(!m.length)return[];let v=[];return m.forEach($=>{O(u,$.date,l,$.time,o)&&(v=$.milks)}),v},E=(u,m,l,o)=>{C.value=l?"edit":"create";let v=a.getYear+"-"+(a.getMonth+1)+"-"+u;T.value={_id:o,date:v,time:l||null,milkDetails:m},D.value=!0},K=u=>{t("confirm",u)},J=()=>{a.decrementMonth(1),t("month",a.getMonth+1),t("year",a.getYear)},X=()=>{a.incrementMonth(1),t("month",a.getMonth+1),t("year",a.getYear)},Z=u=>{t("month",u)},ee=u=>{t("year",u)};return re(()=>{w(),y(),A(),R()}),ce(()=>{y(),A(),R()}),(u,m)=>(r(),h(x,null,[s("div",Ae,[s("div",Re,[n(_e,{onMonth:Z,onYear:ee}),(r(),h(x,null,b(I,l=>s("div",{key:l,class:"text-center text-sm md:text-base lg:text- font-medium border-b mt-3 border-gray-600"},p(l),1)),64)),(r(!0),h(x,null,b(f.value,l=>V((r(),h("div",{key:l,class:"h-26 md:h-36 w-full opacity-50 border-t border-gray-600 align-top"},[s("div",{class:P(["w-full h-full text-xs md:text-sm lg:text-base text-center transition-colors p-3",{"bg-slate-300 text-gray-900 font-medium  ":F(l),"hover:bg-gray-100 hover:text-gray-700":!F(l)}])},[N(p(c.value-(f.value-l))+" ",1),(r(!0),h(x,null,b(d(c.value-(f.value-l),e.events,!0),o=>V((r(),h("div",{key:o.title,class:"hidden md:block"},[s("div",{class:"w-full px-2 py-1 flex space-x-1 items-center whitespace-nowrap overflow-hidden hover:border hover:border-gray-200 cursor-pointer rounded-lg",onClick:v=>u.togglePopover(v,o)},[Pe,s("div",qe,[s("h5",Ne,p(o.title),1)])],8,Ee)])),[[Y,d(c.value-(f.value-l),e.events,!0).length]])),128)),B(c.value-(f.value-l),e.events,!0).length>0?(r(),h("div",{key:0,class:"flex md:hidden h-2/3 w-full justify-center items-center",onClick:o=>E(c.value-(f.value-l),B(c.value-(f.value-l),e.events,!0))},[s("div",Ie,[s("h3",$e,p(B(c.value-(f.value-l),e.events,!0).length),1)])],8,Qe)):q("",!0)],2)])),[[Y,f.value>0]])),128)),(r(!0),h(x,null,b(i.value,l=>(r(),h("div",{key:l,class:"h-24 md:h-36 w-full border-t border-gray-600 align-top"},[s("div",{class:P(["w-full h-full text-xs md:text-sm lg:text-base text-center transition-colors p-1",{"bg-gray-600 text-gray-900 font-medium  ":F(l),"hover:bg-gray-100 hover:text-gray-700":!F(l)}])},[N(p(l)+" ",1),s("div",je,[(r(!0),h(x,null,b(d(l,e.events),o=>V((r(),h("div",{key:o.date,class:"hidden md:block p-1"},[s("div",{class:"w-full flex p-1 shadow-lg border border-gray-800 shadow cursor-pointer rounded-md",onClick:v=>E(l,B(l,e.events,!1,o.time),o.time,o.id)},[s("p",ze,[n(L,{size:"14",path:o.time==="M"?"clockTimeSevenOutline":"clockTimeThreeOutline",class:P(o.time==="M"?"text-yellow-400":"text-orange-500")},null,8,["path","class"]),N(" "+p(o.time=="M"?"เช้า":"บ่าย")+" ("+p(o.sumQty)+") ",1)])],8,Ue)])),[[Y,d(l,e.events).length>0]])),128))]),V(s("div",null,[s("div",{class:"w-full lg:mt-2 text-center items-center overflow-hidden hover:border hover:border-gray-200 cursor-pointer rounded-lg",onClick:o=>E(l,B(l,e.events))},[s("div",We,[n(L,{path:"plus"}),Ge])],8,He)],512),[[Y,d(l,e.events).length<2]]),(r(!0),h(x,null,b(d(l,e.events),o=>(r(),h("div",{key:o.date,class:"flex md:hidden mt-1 w-full justify-center items-center",onClick:v=>E(l,B(l,e.events,!1,o.time),o.time,o.id)},[s("div",{class:P(["h-6 w-full flex justify-center items-center text-xs rounded shadow-sm",[o.time==="M"?"bg-yellow-400":"bg-orange-500"]])},[s("h3",Je,p(o.sumQty),1)],2)],8,Ke))),128))],2)]))),128)),(r(!0),h(x,null,b(_.value,l=>V((r(),h("div",{key:l,class:"h-16 md:h-36 w-full opacity-50"})),[[Y,_.value>0]])),128))]),n(W,{type:"justify-between w-full mt-2",class:"md:hidden"},{default:k(()=>[n(L,{path:"chevronLeft",size:"30",class:"cursor-pointer hover:text-gray-300",onClick:m[0]||(m[0]=l=>J())}),n(L,{path:"chevronRight",size:"30",class:"cursor-pointer hover:text-gray-300",onClick:m[1]||(m[1]=l=>X())})]),_:1})],512),n(G,{modelValue:D.value,"onUpdate:modelValue":m[2]||(m[2]=l=>D.value=l),mode:C.value,data:T.value,onConfirm:K},null,8,["modelValue","mode","data"])],64))}},Ze={data(){return{modalMilk:!1,monthMilk:new Date().getMonth()+1,yearMilk:new Date().getFullYear(),items:[],events:[],forms:[{label:"โค",class:"lg:col-start-2",value:"cow",type:"ddl",module:"cow"},{label:"วันที่รีดนม",value:"date",icon:"calendar",type:"date"}],loading:!1,mode:"create",modalData:null,checked:{code:{value:"date",type:"date"},label:{value:"cow.name"}},datas:[{label:"วันที่รีดนม",class:"text-center",type:"date",value:"date"},{label:"โค",class:"text-center",value:"relate.cow.name"},{label:"ปริมาณน้ำนมดิบ/เช้า (กก.)",class:"text-center",value:"morningQty"},{label:"ปริมาณน้ำนมดิบ/บ่าย (กก.)",class:"text-center",value:"afternoonQty"},{label:"ปริมาณน้ำนมดิบรวม (กก.)",class:"text-center",func:e=>e.morningQty+e.afternoonQty},{label:"จำนวนเงินรวม",class:"text-right",type:"number",value:"amount"}],buttons:[{label:"ลบ",type:"delete",color:"danger"},{label:"แก้ไข",type:"edit",color:"warning"}]}},components:{SectionMain:de,LayoutAuthenticated:me,Table:ue,SectionTitleBarSub:he,MilkModal:G,Calendar:Xe,CardBox:H},computed:{user(){return this.$store.state.auth.user}},created(){this.getMilks()},watch:{monthMilk(e){this.getMilks()},yearMilk(e){this.getMilks()}},methods:{async getMilks(){this.loading=!0;const e=await Q.all({month:this.monthMilk,year:this.yearMilk});if(this.events=[],e.data)for(let t of e.data.milks)this.filterMilk(t);this.loading=!1},async removeMilk(e){this.loading=!0,(await Q.delete(e)).data&&this.getMilks(),this.loading=!1},filterMilk(e){let t={};t.sumQty=0,t.sumAmt=0,e.milkDetails.map(a=>{a.cow=typeof a.cow=="string"?a.relate.cow:a.cow,t.sumQty+=a.qty,t.sumAmt+=a.amount}),t.count=e.milkDetails.length,t.milks=e.milkDetails,t.date=z(e.date,"YYYY-MM-DD").format("DDMMYYYY"),t.time=e.time,t.id=e._id,t.sumQty=t.sumQty.toFixed(2),this.events.push(t)},addMilk(e){this.filterMilk(e)},getMonthMilk(e){this.monthMilk=e},getYearMilk(e){this.yearMilk=e},edit(e){this.modalData=e,this.mode="edit",this.modalMilk=!0}}};function et(e,t,a,I,i,c){const f=g("SectionTitleBarSub"),_=g("MilkModal"),D=g("Calendar"),C=g("CardBox"),T=g("SectionMain"),w=g("LayoutAuthenticated");return r(),S(w,null,{default:k(()=>[n(T,null,{default:k(()=>[n(f,{icon:"cupWater",title:"การรีดนม",btnText:"เพิ่มการรีดนม","has-btn-add":"",onOpenModal:t[0]||(t[0]=y=>{i.mode="create",i.modalMilk=!0})}),n(_,{modelValue:i.modalMilk,"onUpdate:modelValue":t[1]||(t[1]=y=>i.modalMilk=y),mode:i.mode,onConfirm:c.getMilks},null,8,["modelValue","mode","onConfirm"]),i.loading?(r(),S(C,{key:1,loading:""})):(r(),S(C,{key:0},{default:k(()=>[n(D,{events:i.events,onConfirm:c.getMilks,onMonth:c.getMonthMilk,onYear:c.getYearMilk},null,8,["events","onConfirm","onMonth","onYear"])]),_:1}))]),_:1})]),_:1})}const dt=U(Ze,[["render",et]]);export{dt as default};
