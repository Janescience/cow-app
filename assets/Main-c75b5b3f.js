import{z as L,P as B,p as E,m as U,_ as I,l as P,F as A,i as H,j as R,f as z,N as G,v as J,E as c,G as j,H as O,o as i,c as f,w as r,d as l,s,k as m,I as p,t as d,J as M,K as q,h as x,e as K,S as Y,C as Q,D as W}from"./index-529745f7.js";import{T as X}from"./Table-10fec39e.js";import{D as Z,C as $}from"./Criteria-0c493b49.js";import{_ as ee}from"./FormField-6bb0587b.js";import{T as S}from"./alert-d4f4a249.js";import{P as v}from"./protection-4645b73e.js";import{C as te}from"./cow-3853e35a.js";import{_ as oe}from"./FormCheckRadioPicker-8bda58a9.js";import"./Cow-784919ca.js";const se={data(){return{protection:{date:new Date,vaccine:{},qty:null,amount:null,remark:"",cows:[]},corral:"",corrals:null,ddlCorral:[{id:"",label:"เลือกคอก"},{id:"all",label:"ทุกคอก"}],cows:[],showCows:!1,showVaccineCond:!1,vaccineCond:"Y",loading:!1,alert:"",search:"",alertSubmitCow:"",confirmObj:{text:"",func:null,id:null,dataSelected:null,modal:!1}}},emits:["update:modelValue","cancel","confirm"],computed:{value:{get(){return this.modelValue},set(e){this.$emit("update:modelValue",e)}},user(){return this.$store.state.auth.user},resultSearch(){return this.search?this.cows.filter(e=>this.search.toLowerCase().split(" ").every(o=>e.name.toLowerCase().includes(o))):this.cows}},watch:{data(e){e&&this.mode==="edit"&&(this.protection=e,this.protection.date=new Date(e.date))},"protection.qty"(e){e&&(this.protection.amount=e*this.protection.vaccine.amount)},corral(e){e?(this.cows=this.corrals[e],this.alertSubmitCow=""):this.showVaccineCond=!1},vaccineCond(e){e=="N"?this.showCows=!0:this.showCows=!1}},created(){this.getCorrals()},methods:{clear(){this.protection.date=new Date,this.protection.vaccine={},this.protection.qty=null,this.protection.amount=null,this.protection.remark="",this.protection.cows=[],this.corral="",this.cows=[],this.showCows=!1},confirmCancel(e){this.value=!1,this.$emit(e)},cancelConfirm(){this.protection.cows.length>0?this.confirm("มีรายการโคฉีดวัคซีนยังไม่ได้บันทึก ยืนยันยกเลิกใช่หรือไม่ ?",null,null,this.cancel):this.cancel()},cancel(){this.clear(),this.confirmCancel("cancel")},async submit(){this.loading=!0,this.alert="";try{this.mode==="create"?await v.create(this.protection)&&(this.loading=!1,this.value=!1,this.confirmCancel("confirm")):await v.update(this.protection._id,this.protection)&&(this.loading=!1,this.value=!1,this.confirmCancel("confirm")),S.fire({icon:"success",title:"บันทึกข้อมูลสำเร็จ"})}catch(e){console.error("Error : ",e),this.clear(),this.loading=!1,this.alert=await e.response.data.message,S.fire({icon:"error",title:"บันทึกข้อมูลไม่สำเร็จ"})}},async getCorrals(){const e=await te.all();if(e){const o=e.data.cows;this.corrals=B.groupBy(o,"corral");for(let u of Object.keys(this.corrals))this.ddlCorral.push({id:u,label:u})}},removeCow(e){let o=this.cows.indexOf(e);o!==-1&&(this.cows.splice(o,1),this.search="")},addCow(e){this.protection.cows.filter(u=>u.code==e.code).length>0?this.alertSubmitCow="โคซ้ำ กรุณาเลือกโคใหม่":(this.protection.qty+=1,this.protection.cows.push(e),this.alertSubmitCow="",this.removeCow(e))},removeSubmitCow(e){let o=this.protection.cows.indexOf(e);o!==-1&&(this.protection.cows.splice(o,1),this.protection.qty=this.protection.cows.length)},submitCowConfirm(){let e=!1;this.protection.cows.forEach(o=>{this.cows.forEach(u=>{o.code==u.code&&(e=!0)})}),e?this.alertSubmitCow="คอกนี้มีโคซ้ำ กรุณาเลือกคอกใหม่":this.confirm("ยืนยันเลือกคอก "+this.corral+" และโคจำนวน "+this.cows.length+" ตัว ใช่หรือไม่ ?",null,null,this.submitCow)},submitCow(){this.protection.qty+=this.cows.length,this.protection.cows.push(...this.cows),this.cows=[],this.corral="",this.showCows=!1,this.alertSubmitCow=""},resetConfirm(){this.confirm("ต้องการล้างรายการโคฉีดวัคซีนทั้งหมดใช่หรือไม่ ?",null,null,this.reset)},reset(){this.protection.cows=[],this.protection.qty=""},confirm(e,o,u,b){this.confirmObj.text=e,this.confirmObj.func=b,this.confirmObj.id=o,this.confirmObj.dataSelected=u,this.confirmObj.modal=!0}},components:{BaseButton:E,BaseButtons:U,CardBox:I,BaseDivider:P,OverlayLayer:A,FormField:ee,FormControl:H,NotificationBar:R,BaseLevel:z,FormCheckRadioPicker:oe,BaseIcon:G,DDLVaccine:Z,CardBoxModal:J},props:{modelValue:{type:[String,Number,Boolean],default:null},data:{type:Object,default:null},mode:{type:String,default:""}}},le={class:"grid grid-cols-2 lg:grid-cols-4 gap-5"},ae={key:1,class:"flex items-stretch border-b border-gray-100 dark:border-gray-800"},ne={class:"flex items-center py-3 grow font-bold"},ie={key:2,class:"overflow-x-hidden overflow-y-auto max-h-48"},re=s("thead",null,[s("tr",null,[s("th",{class:"whitespace-nowrap text-center"}," รหัสโค "),s("th",{class:"whitespace-nowrap text-center"}," ชื่อโค "),s("th",{class:"whitespace-nowrap text-center"}," สถานะ "),s("th")])],-1),ce={"data-label":"รหัสโค"},de={"data-label":"ชื่อโค"},ue={"data-label":"สถานะ"},he={class:"lg:w-6 whitespace-nowrap"},me={class:"flex items-stretch border-b border-gray-100 dark:border-gray-800"},fe=s("p",{class:"flex items-center py-3 grow font-bold"}," รายการโคฉีดวัคซีน ",-1),pe={key:6,class:"overflow-x-hidden overflow-y-auto max-h-48"},_e=s("thead",null,[s("tr",null,[s("th",{class:"whitespace-nowrap text-center"}," รหัสโค "),s("th",{class:"whitespace-nowrap text-center"}," ชื่อโค "),s("th",{class:"whitespace-nowrap text-center"}," คอก "),s("th",{class:"whitespace-nowrap text-center"}," สถานะ ")])],-1),we={"data-label":"รหัสโค"},be={"data-label":"ชื่อโค"},Ce={"data-label":"คอก"},ye={"data-label":"สถานะ"},ge={class:"lg:w-6 whitespace-nowrap"},ve={key:7,class:"text-center py-10 text-gray-500 dark:text-gray-400"},ke=s("p",null,"ไม่มีรายการ...",-1),xe=[ke];function Be(e,o,u,b,t,n){const C=c("FormControl"),w=c("FormField"),k=c("DDLVaccine"),y=c("BaseDivider"),h=c("BaseButton"),_=c("BaseButtons"),g=c("NotificationBar"),N=c("CardBoxModal"),T=c("CardBox"),F=c("OverlayLayer");return j((i(),f(F,null,{default:r(()=>[j(l(T,{title:(this.mode==="create"?"บันทึก":"แก้ไข")+"การป้องกัน/บำรุง",class:"shadow-lg w-full lg:w-3/5 z-50","header-icon":"close",modal:"",form:"","has-scroll":"",onSubmit:K(n.submit,["prevent"]),onHeaderIconClick:n.cancel},{default:r(()=>{var D;return[s("div",le,[l(w,{label:"วันที่",help:"* ห้ามว่าง"},{default:r(()=>[l(C,{modelValue:t.protection.date,"onUpdate:modelValue":o[0]||(o[0]=a=>t.protection.date=a),icon:"calendar",type:"date",required:""},null,8,["modelValue"])]),_:1}),l(w,{label:"วัคซีน/ยา",help:"* ห้ามว่าง",class:"col-span-2"},{default:r(()=>[l(k,{modelValue:t.protection.vaccine,"onUpdate:modelValue":o[1]||(o[1]=a=>t.protection.vaccine=a),valueType:"object"},null,8,["modelValue"])]),_:1}),(D=t.protection.vaccine)!=null&&D.code?(i(),f(w,{key:0,label:"คอก"},{default:r(()=>[l(C,{modelValue:t.corral,"onUpdate:modelValue":o[2]||(o[2]=a=>t.corral=a),options:t.ddlCorral,required:""},null,8,["modelValue","options"])]),_:1})):m("",!0)]),this.cows.length>0?(i(),f(y,{key:0})):m("",!0),this.cows.length>0?(i(),p("header",ae,[s("p",ne," เลือกโค คอก "+d(t.corral)+" จำนวน "+d(t.cows.length)+" ตัว ",1),l(C,{modelValue:t.search,"onUpdate:modelValue":o[3]||(o[3]=a=>t.search=a),icon:"magnify",placeholder:"ค้นหาชื่อโค"},null,8,["modelValue"])])):m("",!0),this.cows.length>0?(i(),p("div",ie,[s("table",null,[re,s("tbody",null,[(i(!0),p(M,null,q(n.resultSearch,a=>(i(),p("tr",{key:a._id},[s("td",ce,d(a.code),1),s("td",de,d(a.name),1),s("td",ue,d(a.status),1),s("td",he,[l(_,{type:"justify-end lg:justify-start","no-wrap":""},{default:r(()=>[l(h,{color:"success",icon:"plus",small:"",onClick:V=>n.addCow(a)},null,8,["onClick"]),l(h,{color:"danger",icon:"close",small:"",onClick:V=>n.removeCow(a)},null,8,["onClick"])]),_:2},1024)])]))),128))])])])):m("",!0),t.alertSubmitCow?(i(),f(g,{key:3,color:"warning",outline:"",icon:"alertCircleOutline"},{default:r(()=>[x(d(t.alertSubmitCow),1)]),_:1})):m("",!0),this.cows.length>0?(i(),f(_,{key:4,type:"justify-center",class:"mt-2"},{default:r(()=>[l(h,{onClick:n.submitCowConfirm,label:"เลือกทั้งหมด",color:"info"},null,8,["onClick"])]),_:1})):m("",!0),this.cows.length>0?(i(),f(y,{key:5})):m("",!0),s("header",me,[fe,l(_,{class:"mt-2",type:"justify-center"},{default:r(()=>[l(h,{disabled:t.protection.cows.length<=0,onClick:n.resetConfirm,label:"ล้าง",small:"",color:"danger"},null,8,["disabled","onClick"])]),_:1})]),t.protection.cows.length>0?(i(),p("div",pe,[s("table",null,[_e,s("tbody",null,[(i(!0),p(M,null,q(t.protection.cows,a=>(i(),p("tr",{key:a._id},[s("td",we,d(a.code),1),s("td",be,d(a.name),1),s("td",Ce,d(a.corral),1),s("td",ye,d(a.status),1),s("td",ge,[l(_,{type:"justify-end lg:justify-start","no-wrap":""},{default:r(()=>[l(h,{color:"danger",icon:"close",small:"",onClick:V=>n.removeSubmitCow(a)},null,8,["onClick"])]),_:2},1024)])]))),128))])])])):(i(),p("div",ve,xe)),t.protection.cows.length>0?(i(),f(w,{key:8,class:"text-right mt-2"},{default:r(()=>[x(" รวมฉีดวัคซีน "+d(t.protection.qty?t.protection.qty:"-")+" ตัว เป็นเงิน "+d(t.protection.amount?t.protection.amount:"-")+" บาท ",1)]),_:1})):m("",!0),t.alert?(i(),f(g,{key:9,color:"danger",outline:"",icon:"alertCircleOutline"},{default:r(()=>[x(d(t.alert),1)]),_:1})):m("",!0),l(y),l(_,{type:"justify-center"},{default:r(()=>[l(h,{label:"บันทึก",color:"success",type:"submit",disabled:t.protection.cows.length<=0,loading:t.loading},null,8,["disabled","loading"]),l(h,{label:"ยกเลิก",color:"danger",onClick:n.cancelConfirm},null,8,["onClick"])]),_:1}),l(N,{modelValue:t.confirmObj.modal,"onUpdate:modelValue":o[4]||(o[4]=a=>t.confirmObj.modal=a),title:"ยืนยันอีกครั้ง","button-label":"ยืนยัน",onConfirm:t.confirmObj.func,"has-cancel":"","has-button":""},{default:r(()=>[s("p",null,d(t.confirmObj.text),1)]),_:1},8,["modelValue","onConfirm"])]}),_:1},8,["title","onSubmit","onHeaderIconClick"]),[[O,n.value]])]),_:1},512)),[[O,n.value]])}const Se=L(se,[["render",Be]]),De={data(){return{openModal:!1,modalData:null,items:[],forms:[{label:"วัคซีน",value:"vaccine",icon:"needle",type:"ddl",module:"vaccine",valueType:"_id"},{label:"ฉีดวัคซีนล่าสุด",value:"dateCurrent",icon:"calendar",type:"date"},{label:"ฉีดวัคซีนครั้งต่อไป",value:"dateNext",icon:"calendar",type:"date"}],search:{dateCurrent:null,dateNext:null,vaccine:""},loading:!1,mode:"create",dataEdit:null,checked:{label:{value:"vaccine.name"},code:{value:"vaccine.code"}},datas:[{label:"ครั้งที่",value:"seq"},{label:"วัคซีน",value:"vaccine.name"},{label:"จำนวนที่ฉีด (ตัว)",class:"text-center",value:"qty"},{label:"รวมเป็นเงิน (บาท)",class:"text-center",value:"amount"},{label:"วันที่ฉีดวัคซีน",class:"text-center",value:"date",type:"date"},{label:"หมายเหตุ",class:"text-center",value:"remark"}],buttons:[{label:"ลบ",type:"delete",color:"danger"},{label:"แก้ไข",type:"edit",color:"warning",condition:e=>{const o=B.groupBy(this.items,"vaccine._id");for(let u of Object.keys(o)){const b=o[u],t=B.orderBy(b,"seq","desc");if(t.length>0&&e._id==t[0]._id)return!0}return!1}}]}},components:{SectionMain:Y,LayoutAuthenticated:Q,SectionTitleBarSub:W,Table:X,Modal:Se,Criteria:$},computed:{user(){return this.$store.state.auth.user},getDataCopy(){return{...this.modalData}}},created(){this.search.vaccine=this.$route.params.vaccine,this.getDatas(this.search)},methods:{async getDatas(e){this.loading=!0;const o=await v.all(e);this.items=[],o.data&&(this.items=o.data.protections),this.loading=!1},async remove(e){this.loading=!0,(await v.delete(e)).data&&this.getDatas(),this.loading=!1,S.fire({icon:"success",title:"ลบข้อมูลสำเร็จ"})},edit(e){this.modalData=e,this.mode="edit",this.openModal=!0},reset(){this.search.dateCurrent=null,this.search.dateNext=null,this.search.vaccine=""}}};function Ve(e,o,u,b,t,n){const C=c("SectionTitleBarSub"),w=c("Modal"),k=c("Criteria"),y=c("Table"),h=c("SectionMain"),_=c("LayoutAuthenticated");return i(),f(_,null,{default:r(()=>[l(h,null,{default:r(()=>[l(C,{icon:"doctor",title:"การป้องกัน/บำรุง","has-btn-add":"",onOpenModal:o[0]||(o[0]=g=>{t.mode="create",t.openModal=!0}),btnText:"เพิ่มการป้องกัน/บำรุง"}),l(w,{modelValue:t.openModal,"onUpdate:modelValue":o[1]||(o[1]=g=>t.openModal=g),data:n.getDataCopy,mode:t.mode,onConfirm:n.getDatas},null,8,["modelValue","data","mode","onConfirm"]),l(k,{grid:"grid-cols-2 lg:grid-cols-4",onSearch:n.getDatas,onReset:n.reset,forms:t.forms,search:t.search},null,8,["onSearch","onReset","forms","search"]),l(y,{title:"รายการป้องกัน/บำรุง","has-checkbox":"","checked-data":t.checked,items:t.items,datas:t.datas,buttons:t.buttons,onEdit:n.edit,onDelete:n.remove,onDeleteSelected:e.removeSelected,loading:t.loading},null,8,["checked-data","items","datas","buttons","onEdit","onDelete","onDeleteSelected","loading"])]),_:1})]),_:1})}const Ue=L(De,[["render",Ve]]);export{Ue as default};
