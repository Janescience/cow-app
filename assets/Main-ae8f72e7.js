import{z as G,B as K,p as ne,m as re,_ as J,l as X,F as ce,i as de,j as ue,f as Z,N as F,E as k,G as C,H as B,o as n,c as O,w as v,d as s,I as u,k as L,s as a,h as P,t as g,J as x,K as D,e as me,a as y,L as he,M as fe,n as I,q as H,S as ge,C as ke,D as ve}from"./index-74d9eab0.js";import{T as pe}from"./Table-7f21b5b8.js";import{_ as _e}from"./FormField-07dc6251.js";import{_ as we}from"./FormCheckRadioPicker-f19d3d6e.js";import{D as ye}from"./Cow-733e76ed.js";import{M as Q}from"./milking-64a81fbc.js";import{P as xe}from"./param-6f45b0de.js";import{T as W}from"./alert-835c877b.js";import{u as Me,_ as be}from"./Top-c2433572.js";import"./cow-01e8ae3f.js";const De={data(){return{milk:{date:new Date,time:this.checkTime()},milkDetail:{cow:{},qty:null,amount:null},priceRawMilk:null,milkDetails:[],loading:!1,alert:{}}},emits:["update:modelValue","cancel","confirm"],computed:{calAmount(){return this.milkDetail.amount=this.milkDetail.qty*this.priceRawMilk,this.milkDetail.amount},user(){return this.$store.state.auth.user},value:{get(){return this.modelValue},set(e){this.$emit("update:modelValue",e)}}},watch:{data:{handler(e,t){e&&(this.mode=="edit"&&(this.milkDetails=e.milkDetails),this.milk.date=e.date?new Date(e.date):new Date,this.milk._id=e._id,this.milk.time=e.time?e.time:this.checkTime(),this.getPriceRawMilk())}},"milkDetail.cow"(e){e!=null&&Object.keys(e).length>0&&this.milkDetails.length>0&&(this.alert={},this.milkDetails.filter(o=>o.cow.code===e.code).length>0&&(this.milkDetail.cow={},this.alert.text="โคซ้ำ กรุณาเลือกรายการอื่น",this.alert.color="warning"))}},created(){this.getPriceRawMilk()},methods:{clear(){this.milk={},this.milk.date=new Date,this.milk.time="M",this.milkDetails=[]},confirmCancel(e){this.value=!1,this.$emit(e)},confirm(){this.clear(),this.confirmCancel("confirm")},cancel(){this.clear(),this.confirmCancel("cancel")},removeDetail(e){let t=this.milkDetails.indexOf(e);t!==-1&&this.milkDetails.splice(t,1)},reset(){this.milkDetail.cow={},this.milkDetail.qty=null,this.milkDetail.amount=null},checkTime(){return new Date().getHours()<=12?"M":"A"},add(){this.milkDetail.cow&&this.milkDetail.qty>0&&this.milkDetail.amount?this.milkDetails.filter(t=>{var o;return t.cow.code===((o=this.milkDetail)==null?void 0:o.cow.code)}).length<=0?(this.milkDetails.push(this.milkDetail),this.alert={},this.milkDetail={}):(this.alert.text="โคซ้ำ",this.alert.color="warning"):(this.alert.text="กรุณากรอกข้อมูลให้ครบ",this.alert.color="warning")},async submit(){this.loading=!0,this.alert="",this.milk.milkDetails=this.milkDetails;const e={...this.milk};try{this.mode==="create"?await Q.create(e)&&(this.loading=!1,this.confirm(),W.fire({icon:"success",title:"บันทึกข้อมูลสำเร็จ"})):await Q.update(this.milk._id,this.milk)&&(this.loading=!1,this.confirm(),W.fire({icon:"success",title:"บันทึกข้อมูลสำเร็จ"}))}catch(t){console.error("Error : ",t),this.loading=!1,this.alert.text=t.response.data.message,this.alert.color="danger"}},async getPriceRawMilk(){const e=await xe.all({code:"RAW_MILK"});if(e.data){const t=e.data.params;t.length>0&&(this.priceRawMilk=t[0].valueNumber)}},formatDate(e){return K(e).format("DD/MM/YYYY")}},components:{BaseButton:ne,BaseButtons:re,CardBox:J,BaseDivider:X,OverlayLayer:ce,FormField:_e,FormControl:de,NotificationBar:ue,BaseLevel:Z,DDLCow:ye,FormCheckRadioPicker:we,BaseIcon:F},props:{modelValue:{type:[String,Number,Boolean],default:null},mode:{type:String,default:""},data:{type:Object,default:null}}},Ce={key:0,class:"grid lg:grid-cols-4 grid-cols-2 gap-5"},Be={class:"grid grid-cols-2 lg:grid-cols-4 gap-5"},Ye=a("header",{class:"flex items-stretch border-b border-gray-100 dark:border-gray-800"},[a("p",{class:"flex items-center py-3 grow font-bold"}," รายการรีดนม ")],-1),Ve={key:3,class:"overflow-x-auto"},Te=a("thead",null,[a("tr",null,[a("th",{class:"whitespace-nowrap text-center"}," รหัสโค "),a("th",{class:"whitespace-nowrap text-center"}," ชื่อโค "),a("th",{class:"whitespace-nowrap text-center"}," น้ำนมดิบ (กก.) "),a("th",{class:"whitespace-nowrap text-center"}," จำนวนเงิน "),a("th")])],-1),Se={"data-label":"รหัสโค"},Fe={"data-label":"ชื่อโค"},Oe={"data-label":"น้ำนมดิบ/กก.",class:"text-center"},Le={"data-label":"จำนวนเงิน",class:"text-right"},Ae={class:"lg:w-6 whitespace-nowrap"},Re={key:4,class:"text-center py-10 text-gray-500 dark:text-gray-400"},qe=a("p",null,"ไม่มีรายการ...",-1),Ee=[qe];function Pe(e,t,o,j,i,r){const h=k("FormControl"),w=k("FormField"),Y=k("FormCheckRadioPicker"),V=k("BaseDivider"),T=k("DDLCow"),_=k("BaseButton"),M=k("BaseButtons"),N=k("NotificationBar"),$=k("CardBox"),A=k("OverlayLayer");return C((n(),O(A,null,{default:v(()=>[C(s($,{title:o.mode==="create"?"การรีดนม":"การรีดนม ("+((i.milk.time=="M"?"เช้า":"บ่าย")+" - "+r.formatDate(i.milk.date))+")",class:"shadow-lg w-full lg:w-1/2 z-50","header-icon":"close",modal:"",form:"","has-scroll":"",onSubmit:me(r.submit,["prevent"]),onHeaderIconClick:r.cancel},{default:v(()=>{var R;return[o.mode!="edit"?(n(),u("div",Ce,[s(w,{label:"วันที่รีดนม",help:"* ห้ามว่าง"},{default:v(()=>[s(h,{modelValue:i.milk.date,"onUpdate:modelValue":t[0]||(t[0]=f=>i.milk.date=f),icon:"calendar",type:"date",required:"",disabled:o.mode=="edit"},null,8,["modelValue","disabled"])]),_:1}),s(w,{label:"รอบ"},{default:v(()=>[s(Y,{modelValue:i.milk.time,"onUpdate:modelValue":t[1]||(t[1]=f=>i.milk.time=f),type:"radio",name:"milk-time",options:{M:"เช้า",A:"บ่าย"},disabled:o.mode=="edit"},null,8,["modelValue","disabled"])]),_:1})])):L("",!0),o.mode!="edit"?(n(),O(V,{key:1})):L("",!0),a("div",Be,[s(w,{label:"โค",help:"* ห้ามว่าง"},{default:v(()=>[s(T,{modelValue:i.milkDetail.cow,"onUpdate:modelValue":t[2]||(t[2]=f=>i.milkDetail.cow=f),valueType:"object"},null,8,["modelValue"])]),_:1}),s(w,{label:"น้ำนมดิบ (กก.)",help:"* ห้ามว่าง"},{default:v(()=>[s(h,{modelValue:i.milkDetail.qty,"onUpdate:modelValue":t[3]||(t[3]=f=>i.milkDetail.qty=f),type:"number",icon:"scale"},null,8,["modelValue"])]),_:1}),s(w,{label:"คิดเป็นเงิน",help:"ราคาน้ำนมดิบ/กก. "+i.priceRawMilk+" บาท"},{default:v(()=>[s(h,{modelValue:r.calAmount,"onUpdate:modelValue":t[4]||(t[4]=f=>r.calAmount=f),type:"number",icon:"cashMultiple"},null,8,["modelValue"])]),_:1},8,["help"]),s(M,{type:"justify-start"},{default:v(()=>[s(_,{label:"ล้าง",color:"danger",onClick:t[5]||(t[5]=f=>r.reset())}),s(_,{label:"เพิ่ม",color:"info",onClick:t[6]||(t[6]=f=>r.add())})]),_:1})]),(R=i.alert)!=null&&R.text?(n(),O(N,{key:2,color:i.alert.color,outline:"",icon:"alertCircleOutline"},{default:v(()=>[P(g(i.alert.text),1)]),_:1},8,["color"])):L("",!0),Ye,i.milkDetails.length>0?(n(),u("div",Ve,[a("table",null,[Te,a("tbody",null,[(n(!0),u(x,null,D(i.milkDetails,f=>(n(),u("tr",{key:f.cow._id},[a("td",Se,g(f.cow.code),1),a("td",Fe,g(f.cow.name),1),a("td",Oe,g(f.qty.toFixed(2)),1),a("td",Le,g(f.amount),1),a("td",Ae,[s(M,{type:"justify-end lg:justify-start","no-wrap":""},{default:v(()=>[s(_,{color:"danger",icon:"trashCanOutline",small:"",onClick:q=>r.removeDetail(f)},null,8,["onClick"])]),_:2},1024)])]))),128))])])])):(n(),u("div",Re,Ee)),s(M,{type:"justify-center mt-3"},{default:v(()=>[s(_,{label:"ยกเลิก",color:"danger",onClick:r.cancel},null,8,["onClick"]),s(_,{label:"บันทึก",color:"success",type:"submit",disabled:i.milkDetails.length==0,loading:i.loading},null,8,["disabled","loading"])]),_:1})]}),_:1},8,["title","onSubmit","onHeaderIconClick"]),[[B,r.value]])]),_:1},512)),[[B,r.value]])}const ee=G(De,[["render",Pe]]),Ne={ref:"calendarContainer",class:"min-h-full min-w-full text-gray-300"},$e={class:"w-full grid grid-cols-7"},Ie=["onClick"],Qe=a("div",{class:"w-1/12"},[a("div",{class:"h-2 w-2 rounded-full bg-orange-600"})],-1),je={class:"w-11/12"},Ue={class:"text-xs tracking-tight text-clip overflow-hidden"},ze=["onClick"],He={class:"w-1/12 mr-1"},We={class:"w-11/12"},Ge={class:"text-xs tracking-tight text-clip text-left overflow-hidden"},Ke=["onClick"],Je={class:"h-6 w-6 flex justify-center items-center text-xs bg-orange-600 rounded-full shadow-sm"},Xe={class:"font-medium text-white"},Ze={class:"lg:mt-2"},et=["onClick"],tt={class:"text-sm text-clip overflow-hidden items-center"},lt=["onClick"],at={class:"opacity-40"},ot=a("p",{class:"hidden md:block"}," รีดนม",-1),st=["onClick"],it={class:"font-medium text-black"},nt={key:0,class:"md:hidden"},rt=["onClick"],ct={class:"text-sm text-clip overflow-hidden"},dt={__name:"Calendar",props:{events:{type:Object,required:!0}},emits:["confirm","month","year"],setup(e,{emit:t}){const o=Me();o.$subscribe((m,d)=>{$(),A()}),t("month",o.getMonth+1),t("year",o.getYear);const j={1:"อา",2:"จ.",3:"อ.",4:"พ.",5:"พฤ",6:"ศ.",7:"ส."},i=y(0),r=y(0),h=y(0),w=y(0),Y=y(!1),V=y(!1),T=y([]),_=y(""),M=y("create"),N=y({}),$=()=>{i.value=new Date(o.getYear,o.getMonth+1,0).getDate()},A=()=>{h.value=new Date(o.getYear,o.getMonth,1).getDay()},R=()=>{r.value=new Date(o.getYear,o.getMonth,0).getDate()},f=()=>{let m=h.value<=4?35:42;w.value=m-i.value-h.value},q=m=>{let d=new Date;return o.getYear==d.getFullYear()&&o.getMonth==d.getMonth()&&m==d.getDate()},z=(m,d,l,c,p)=>o.getYear==d.substring(4,8)&&o.getMonth+(l?0:1)==d.substring(2,4)&&m==d.substring(0,2)&&c==p,S=(m,d,l)=>{if(!d.length)return[];let c=[];return d.forEach(p=>{z(m,p.date,l)&&c.push(p)}),c},b=(m,d,l,c)=>{if(!d.length)return[];let p=[];return d.forEach(U=>{z(m,U.date,l,U.time,c)&&(p=U.milks)}),p},E=(m,d,l,c)=>{M.value=l?"edit":"create";let p=o.getYear+"-"+(o.getMonth+1)+"-"+m;N.value={_id:c,date:p,time:l||null,milkDetails:d},Y.value=!0},te=(m,d)=>{const l=S(m,d);T.value=l,_.value=m,V.value=!0},le=m=>{t("confirm",m)},ae=()=>{o.decrementMonth(1),t("month",o.getMonth+1),t("year",o.getYear)},oe=()=>{o.incrementMonth(1),t("month",o.getMonth+1),t("year",o.getYear)},se=m=>{t("month",m)},ie=m=>{t("year",m)};return he(()=>{$(),A(),R(),f()}),fe(()=>{A(),R(),f()}),(m,d)=>(n(),u(x,null,[a("div",Ne,[a("div",$e,[s(be,{onMonth:se,onYear:ie}),(n(),u(x,null,D(j,l=>a("div",{key:l,class:"text-center text-sm md:text-base lg:text- font-medium border-b mt-3 border-gray-600"},g(l),1)),64)),(n(!0),u(x,null,D(h.value,l=>C((n(),u("div",{key:l,class:"h-26 md:h-36 w-full opacity-50 border-t border-gray-600 align-top"},[a("div",{class:I(["w-full h-full text-xs md:text-sm lg:text-base text-center transition-colors p-3",{"bg-slate-300 text-gray-900 font-medium  ":q(l),"hover:bg-gray-100 hover:text-gray-700":!q(l)}])},[P(g(r.value-(h.value-l))+" ",1),(n(!0),u(x,null,D(S(r.value-(h.value-l),e.events,!0),c=>C((n(),u("div",{key:c.title,class:"hidden md:block"},[a("div",{class:"w-full px-2 py-1 flex space-x-1 items-center whitespace-nowrap overflow-hidden hover:border hover:border-gray-200 cursor-pointer rounded-lg",onClick:p=>m.togglePopover(p,c)},[Qe,a("div",je,[a("h5",Ue,g(c.title),1)])],8,Ie)])),[[B,S(r.value-(h.value-l),e.events,!0).length]])),128)),b(r.value-(h.value-l),e.events,!0).length>3?(n(),u("div",{key:0,class:"hidden md:flex mt-2 w-full px-2 py-1 space-x-2 items-center whitespace-nowrap overflow-hidden hover:text-gray-800 hover:font-medium cursor-pointer rounded-sm",onClick:c=>E(r.value-(h.value-l),b(r.value-(h.value-l),e.events,!0))},[a("div",He,[s(F,{path:"plus"})]),a("div",We,[a("h6",Ge,g(" มีอีก "+(b(r.value-(h.value-l),e.events,!0).length-3)+" รายการ"),1)])],8,ze)):L("",!0),b(r.value-(h.value-l),e.events,!0).length>0?(n(),u("div",{key:1,class:"flex md:hidden h-2/3 w-full justify-center items-center",onClick:c=>E(r.value-(h.value-l),b(r.value-(h.value-l),e.events,!0))},[a("div",Je,[a("h3",Xe,g(b(r.value-(h.value-l),e.events,!0).length),1)])],8,Ke)):L("",!0)],2)])),[[B,h.value>0]])),128)),(n(!0),u(x,null,D(i.value,l=>(n(),u("div",{key:l,class:"h-26 md:h-36 w-full border-t border-gray-600 align-top"},[a("div",{class:I(["w-full h-full text-xs md:text-sm lg:text-base text-center transition-colors p-2",{"bg-gray-600 text-gray-900 font-medium  ":q(l),"hover:bg-gray-100 hover:text-gray-700":!q(l)}])},[P(g(l)+" ",1),a("div",Ze,[(n(!0),u(x,null,D(S(l,e.events),c=>C((n(),u("div",{key:c.date,class:"hidden md:block p-1"},[a("div",{class:"w-full flex p-1 shadow-lg border border-gray-800 shadow cursor-pointer rounded-md",onClick:p=>E(l,b(l,e.events,!1,c.time),c.time,c.id)},[a("p",tt,[s(F,{path:c.time==="M"?"clockTimeSevenOutline":"clockTimeThreeOutline",class:I(c.time==="M"?"text-yellow-400":"text-orange-500")},null,8,["path","class"]),P(" "+g(c.time=="M"?"เช้า":"บ่าย")+" - "+g(c.sumQty)+" กก. ",1)])],8,et)])),[[B,S(l,e.events).length>0]])),128))]),C(a("div",null,[a("div",{class:"w-full lg:mt-2 text-center items-center overflow-hidden hover:border hover:border-gray-200 cursor-pointer rounded-lg",onClick:c=>E(l,b(l,e.events))},[a("div",at,[s(F,{path:"plus"}),ot])],8,lt)],512),[[B,S(l,e.events).length<2]]),(n(!0),u(x,null,D(S(l,e.events),c=>(n(),u("div",{key:c.date,class:"flex md:hidden mt-1 w-full justify-center items-center",onClick:p=>te(l,e.events)},[a("div",{class:I(["h-6 w-6 flex justify-center items-center text-xs rounded shadow-sm",[c.time==="M"?"bg-yellow-400":"bg-orange-500"]])},[a("h3",it,g(c.sumQty),1)],2)],8,st))),128))],2)]))),128)),(n(!0),u(x,null,D(w.value,l=>C((n(),u("div",{key:l,class:"h-16 md:h-36 w-full opacity-50"})),[[B,w.value>0]])),128))]),s(Z,{type:"justify-between w-full mt-2",class:"md:hidden"},{default:v(()=>[s(F,{path:"chevronLeft",size:"30",class:"cursor-pointer hover:text-gray-300",onClick:d[0]||(d[0]=l=>ae())}),s(F,{path:"chevronRight",size:"30",class:"cursor-pointer hover:text-gray-300",onClick:d[1]||(d[1]=l=>oe())})]),_:1}),s(X),V.value?(n(),u("div",nt,[P(" รายการรีดนม "+g(_.value)+"/"+g(H(o).getMonth+1)+"/"+g(H(o).getYear+543)+" ",1),(n(!0),u(x,null,D(T.value,l=>C((n(),u("div",{key:l.date},[a("div",{class:"w-full text-left flex overflow-hidden p-2 mt-2 border border-gray-800 shadow cursor-pointer rounded-md",onClick:c=>E(_.value,b(_.value,e.events,!1,l.time),l.time,l.id)},[a("p",ct," รอบ "+g(l.time=="M"?"เช้า":"บ่าย")+" น้ำนมดิบ "+g(l.sumQty)+" กก. รีดแล้ว "+g(l.count)+" ตัว ",1)],8,rt)])),[[B,T.value.length>0]])),128))])):L("",!0)],512),s(ee,{modelValue:Y.value,"onUpdate:modelValue":d[2]||(d[2]=l=>Y.value=l),mode:M.value,data:N.value,onConfirm:le},null,8,["modelValue","mode","data"])],64))}},ut={data(){return{modalMilk:!1,monthMilk:new Date().getMonth()+1,yearMilk:new Date().getFullYear(),items:[],events:[],forms:[{label:"โค",class:"lg:col-start-2",value:"cow",type:"ddl",module:"cow"},{label:"วันที่รีดนม",value:"date",icon:"calendar",type:"date"}],loading:!1,mode:"create",modalData:null,checked:{code:{value:"date",type:"date"},label:{value:"cow.name"}},datas:[{label:"วันที่รีดนม",class:"text-center",type:"date",value:"date"},{label:"โค",class:"text-center",value:"relate.cow.name"},{label:"ปริมาณน้ำนมดิบ/เช้า (กก.)",class:"text-center",value:"morningQty"},{label:"ปริมาณน้ำนมดิบ/บ่าย (กก.)",class:"text-center",value:"afternoonQty"},{label:"ปริมาณน้ำนมดิบรวม (กก.)",class:"text-center",func:e=>e.morningQty+e.afternoonQty},{label:"จำนวนเงินรวม",class:"text-right",type:"number",value:"amount"}],buttons:[{label:"ลบ",type:"delete",color:"danger"},{label:"แก้ไข",type:"edit",color:"warning"}]}},components:{SectionMain:ge,LayoutAuthenticated:ke,Table:pe,SectionTitleBarSub:ve,MilkModal:ee,Calendar:dt,CardBox:J},computed:{user(){return this.$store.state.auth.user}},created(){this.getMilks()},watch:{monthMilk(e){this.getMilks()},yearMilk(e){this.getMilks()}},methods:{async getMilks(){this.loading=!0;const e=await Q.all({month:this.monthMilk,year:this.yearMilk});if(this.events=[],e.data)for(let t of e.data.milks)this.filterMilk(t);this.loading=!1},async removeMilk(e){this.loading=!0,(await Q.delete(e)).data&&this.getMilks(),this.loading=!1},filterMilk(e){let t={};t.sumQty=0,t.sumAmt=0,e.milkDetails.map(o=>{o.cow=typeof o.cow=="string"?o.relate.cow:o.cow,t.sumQty+=o.qty,t.sumAmt+=o.amount}),t.count=e.milkDetails.length,t.milks=e.milkDetails,t.date=K(e.date,"YYYY-MM-DD").format("DDMMYYYY"),t.time=e.time,t.id=e._id,this.events.push(t)},addMilk(e){this.filterMilk(e)},getMonthMilk(e){this.monthMilk=e},getYearMilk(e){this.yearMilk=e},edit(e){this.modalData=e,this.mode="edit",this.modalMilk=!0}}};function mt(e,t,o,j,i,r){const h=k("SectionTitleBarSub"),w=k("MilkModal"),Y=k("Calendar"),V=k("CardBox"),T=k("SectionMain"),_=k("LayoutAuthenticated");return n(),O(_,null,{default:v(()=>[s(T,null,{default:v(()=>[s(h,{icon:"cupWater",title:"การรีดนม",btnText:"เพิ่มการรีดนม","has-btn-add":"",onOpenModal:t[0]||(t[0]=M=>{i.mode="create",i.modalMilk=!0})}),s(w,{modelValue:i.modalMilk,"onUpdate:modelValue":t[1]||(t[1]=M=>i.modalMilk=M),mode:i.mode,onConfirm:r.getMilks},null,8,["modelValue","mode","onConfirm"]),i.loading?(n(),O(V,{key:1,loading:""})):(n(),O(V,{key:0},{default:v(()=>[s(Y,{events:i.events,onConfirm:r.getMilks,onMonth:r.getMonthMilk,onYear:r.getYearMilk},null,8,["events","onConfirm","onMonth","onYear"])]),_:1}))]),_:1})]),_:1})}const Mt=G(ut,[["render",mt]]);export{Mt as default};
